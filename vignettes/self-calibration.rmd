---
title: "self-calibration"
output: html_document
author: Hyunji Moon, Shinyoung Kim
---

```{r setup, include=FALSE}
library(SBC) #devtools::install_github("hyunjimoon/SBC")
library(cmdstanr)
library(parallel)
library(bayesplot)
library(posterior)
library(dplyr)
library(future)
library(ggpubr)
options(mc.cores = parallel::detectCores())
plan(multisession)
options(SBC.min_chunk_size = 5)
set.seed(1984)
devtools::load_all()
```

```{r}
generator_gmm <- function(mixture_mean_draws_rvars, mixture_bw_draws_rvars, fixed_values){
  #print(rvar_rng(rnorm, n = 1, sample(mixture_mean_draws_rvars$a, 1, replace=TRUE), 1))
  # fixed value across simultated datasets
  N <- fixed_values$N
  shape <- fixed_values$shape
  M <- fixed_values$M
  # fixed distribution across simultated datasets
  b <- fixed_values$b  # length (K)
  # paramter - target, updated distribution
  a <- rvar_rng(rnorm, n = 1, sample(mixture_mean_draws_rvars$a, 1, replace=TRUE), sd=mixture_bw_draws_rvars$a) # <S>(n_vars, S * M) -> <S>(n_vars)
  # predictor
  X = fixed_values$X
  # generate
  mu = as.vector(exp(a + X %**% b))
  Y <- rvar_rng(rgamma, n = nobs, shape = shape, scale = mu / shape, ndraws = nsims)
  gen_rvars <- draws_rvars(nobs = nobs, Y = Y, npredictors = npredictors, X = X, 
                           nsims = nsims, mm_mean = mixture_mean_draws_rvars$a, mm_bandwidth = mixture_bw_draws_rvars$a, shape = shape)
  SBC_datasets(
    parameters = as_draws_matrix(list(a = a)), 
    generated = draws_rvars_to_standata(gen_rvars)
  )
}

nsims = 10
nobs = 10
ndraws = 300
npredictors = 15
ntarget_params = 1
chains = 4
fixed_values <- list(nobs = nobs, shape = 1, ndraws = ndraws, b = rvar_rng(rnorm, ndraws = 1, n = npredictors, 0, 1), X = rvar(array(rnorm(n = nobs * npredictors, mean = 1, sd = 1), dim = c(1, nobs, npredictors))))
mm_mean = draws_rvars(a = rvar(array(rep(rnorm(nsims, 2, 1), each = nsims), dim = c(nsims, nsims))))
mm_bandwidth = draws_rvars(a = rvar(array(rep(1, nsims), dim=c(nsims, 1))))

datasets_25 <- generator_gmm(
  mixture_mean_draws_rvars = mm_mean,
  mixture_bw_draws_rvars = mm_bandwidth,
  fixed_values = fixed_values
)

mod_gmm <- cmdstanr::cmdstan_model("./models/gamma-reg_gmm.stan")
backend_hmc_gmm <- SBC_backend_cmdstan_sample(mod_gmm, chains = chains, iter_sampling = ndraws / chains)
#result_25_hmc <- compute_results(datasets_25, backend_hmc)

param_sc_hmc <- self_calib(generator_gmm, backend_hmc_gmm, mm_mean, mm_bandwidth, nsims_fn = function(...){10}, thin = 3, fixed_generator_args = list(fixed_values = fixed_values))
```

@@@@@@@@@@@@@@@@@ END GMM TEST CODE @@@@@@@@@@@@@@@@@@

```{r}
thin_ranks_v = 1
backend_vi <- SBC_backend_cmdstan_variational(mod_gr, output_samples = M, algorithm = "fullrank")
result_25_vi <- compute_results(datasets_25, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_25_vi)
result_22_vi <- compute_results(datasets_22, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_22_vi)
#target calibration
evolve_df <- list()
for (v in tv){
 evolve_df[[v]] <- list(median = rep(NA,1), sd = rep(NA,1), scm = NA, scm_init = NA) 
}
param_sc_vi <- self_calib(generator, clamp_val, clamp_dist, param_init_25, predictor, backend_vi, tv, thin_ranks_v, 1, evolve_df, delivDir)

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  clamp_val = clamp_val,
  clamp_dist = clamp_dist,
  param = param_sc_vi,
  predictor = predictor
)
result_sc_vi <- compute_results(datasets_sc_vi, backend_vi, thin_ranks = thin_ranks_v) 

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  hyperparam = hyperparam,
  param = param_sc_vi,
  predictor = predictor
)
# before after compare with ecdf and rank summary
# graphical inspection
plot_rank_hist(result_25_vi)
plot_rank_hist(result_sc_vi)
```
