---
title: "self-calibration"
output: html_document
author: Hyunji Moon, Shinyoung Kim
---

```{r setup, include=FALSE}
library(SBC) #devtools::install_github("hyunjimoon/SBC")
library(cmdstanr)
library(parallel)
library(bayesplot)
library(posterior)
library(dplyr)
library(future)
library(ggpubr)
options(mc.cores = parallel::detectCores())
plan(multisession)
options(SBC.min_chunk_size = 5)
set.seed(1984)
devtools::load_all()
```

```{r}
generator_gmm <- function(nsims, mixture_means_rvar, mixture_bw_rvar, fixed_values){
  # fixed value across simulated datasets
  nobs <- fixed_values$nobs
  shape <- fixed_values$shape
  ntarget_params <- 1 #dim(mixture_means_rvar)[[1]]
  ndraws <- fixed_values$ndraws
  # fixed distribution across simultated datasets
  a <- rep(mixture_means_rvar, nsims)
  b <- fixed_values$b  # length (K)
  # predictor
  X <- fixed_values$X
  # target paramter
  a <- rvar_rng(rnorm, n = 1, as.vector(sample(mixture_means_rvar, 1, replace=TRUE)), sd=mixture_bw_rvar) # <S>(n_vars, S * M) -> <S>(n_vars)
  # generate
  mu <- as.vector(exp(a + X %**% b))  # output (S, 1) -> (S) vector
  Y <- rvar_rng(rgamma, n = nobs, shape = shape, scale = mu / shape, ndraws = nsims)
  gen_rvars <- draws_rvars(nobs = nobs, Y = Y, npredictors = npredictors, X = X, ntarget_params = ntarget_params,
                           nsims = nsims, mm_mean = mixture_means_rvar, mm_bandwidth = mixture_bw_rvar, shape = shape)
  SBC_datasets(
    parameters = as_draws_matrix(list(a = a)), 
    generated = draws_rvars_to_standata(gen_rvars)
  )
}

nsims = 10
nobs = 10
ndraws = 300
npredictors = 15
ntarget_params = 1
chains = 4
fixed_values <- list(nobs = nobs, shape = 1, ndraws = ndraws, b = rvar_rng(rnorm, ndraws = 1, n = npredictors, 0, 1), X = rvar(array(rnorm(n = nobs * npredictors, mean = 1, sd = 1), dim = c(1, nobs, npredictors))))
mm_mean = rvar(array(rep(rnorm(nsims, 2, 1), each = nsims), dim = c(nsims, nsims)))
#mm_mean = rvar(array(rep(rnorm(nsims * ntarget_params, 2, 1), nsims), dim = c(nsims, ntarget_params, nsims))) rvar<10>[1,10]
# mm_mean = rvar(array(rnorm(nsims * ntarget_params * nsims, 2, 1), dim = c(nsims, ntarget_params, nsims))) rvar<10>[1,10]
mm_bandwidth = rvar(array(rep(1, nsims), dim=c(nsims, 1)))

datasets_25 <- generator_gmm(
  nsims = nsims,
  mixture_means_rvar = mm_mean,
  mixture_bw_rvar = mm_bandwidth,
  fixed_values = fixed_values
)

mod_gmm <- cmdstanr::cmdstan_model("./models/gamma-reg_gmm.stan")
backend_hmc_gmm <- SBC_backend_cmdstan_sample(mod_gmm, chains = chains, iter_sampling = ndraws / chains)
#result_25_hmc <- compute_results(datasets_25, backend_hmc)

param_sc_hmc <- self_calib(generator_gmm, backend_hmc_gmm, list(a = 1), mixture_means_init = mm_mean, mixture_bw_init = mm_bandwidth, thin = 3, 
                           nsims_fn = function(...){10}, fixed_generator_args = list(fixed_values = fixed_values))
```

@@@@@@@@@@@@@@@@@ END GMM TEST CODE @@@@@@@@@@@@@@@@@@

```{r}
thin_ranks_v = 1
backend_vi <- SBC_backend_cmdstan_variational(mod_gr, output_samples = M, algorithm = "fullrank")
result_25_vi <- compute_results(datasets_25, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_25_vi)
result_22_vi <- compute_results(datasets_22, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_22_vi)
#target calibration
evolve_df <- list()
for (v in tv){
 evolve_df[[v]] <- list(median = rep(NA,1), sd = rep(NA,1), scm = NA, scm_init = NA) 
}
param_sc_vi <- self_calib(generator, clamp_val, clamp_dist, param_init_25, predictor, backend_vi, tv, thin_ranks_v, 1, evolve_df, delivDir)

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  clamp_val = clamp_val,
  clamp_dist = clamp_dist,
  param = param_sc_vi,
  predictor = predictor
)
result_sc_vi <- compute_results(datasets_sc_vi, backend_vi, thin_ranks = thin_ranks_v) 

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  hyperparam = hyperparam,
  param = param_sc_vi,
  predictor = predictor
)
# before after compare with ecdf and rank summary
# graphical inspection
plot_rank_hist(result_25_vi)
plot_rank_hist(result_sc_vi)
```
