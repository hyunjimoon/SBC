---
title: "self-calibration"
output: html_document
author: Hyunji Moon, Shinyoung Kim
---

```{r setup, include=FALSE}
library(SBC) #devtools::install_github("hyunjimoon/SBC")
library(cmdstanr)
library(parallel)
library(bayesplot)
library(posterior)
library(dplyr)
library(future)
library(ggpubr)
options(mc.cores = parallel::detectCores())
plan(multisession)
options(SBC.min_chunk_size = 5)
set.seed(1984)
devtools::load_all()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  include = TRUE,  cache = FALSE,  collapse = TRUE,  echo = TRUE,
  message = FALSE, tidy = FALSE,  warning = FALSE,   comment = "  ",
  dev = "png", dev.args = list(bg = '#FFFFF8'), dpi = 300,
  fig.align = "center",  fig.width = 7,  fig.asp = 0.618,  fig.show = "hold",
  out.width = "90%")
```

```{r  warning=FALSE}
generator <- function(hyperparam, param, predictor = NULL){
  # hyperparamter
  alpha = hyperparam$alpha
  # paramter
  beta0 = param$beta0
  beta1 = param$beta1
  # predictor
  x = predictor$x
  # generate
  S = ndraws(param[[1]])
  mean = exp(beta0 + beta1 * x)
  y <- rfun(rgamma) (n = N, shape = alpha, rate = shape/mean) #k/theta = mean
  gen_rvars <- draws_rvars(N = N, y = y)
  # SBC reshape rvar<S>[1] distributed to each parallel simulation as rvar<1>[1]
  SBC_datasets(
    parameters = as_draws_matrix(param), 
    generated = draws_rvars_to_standata(gen_rvars)
  )
}
mod_gr = set_get_Dir("gamma-reg")$mod
```

```{r  warning=FALSE}
S = 100
N = 5
M = 100
chains = 4
hyperparam = list(alpha = rvar(rgamma(1, shape = .01, rate =.01)))
predictor = draws_rvars(x = rfun(rnorm, ndraws = 1) (n = S, 0, 2))
backend_hmc <- SBC_backend_cmdstan_sample(mod_gr, chains = chains, iter_sampling = M * 10 / chains)
datasets_25 <- generator(
  hyperparam = hyperparam,
  param = draws_rvars(beta0 = rvar(rnorm(S, 2, 5)), beta1 = rvar(rnorm(S, 0, 1))),
  predictor =  predictor
)
result_25 <- compute_results(datasets_25, backend_hmc)
plot_rank_hist(result_25)
```

```{r  warning=FALSE}
datasets_22 <- generator(
  hyperparam = hyperparam,
  param = draws_rvars(beta0 = rvar(rnorm(S, 2, 2)), beta1 = rvar(rnorm(S, 0, 1))),
  predictor = predictor
)
result_22 <- compute_results(datasets_22, backend_hmc)
plot_rank_hist(result_22)
```

```{r warning=FALSE}
delivDir = set_get_Dir("gamma-reg")$delivDir
# target calibration
tv = c("beta0", "beta1")
param_0 <- as_draws_rvars(subset_draws(datasets_22$parameters, variable = tv))
#target calibration
evolve_df <- list()
for (v in tv){
 evolve_df[[v]] <- list(median = rep(NA,1), sd = rep(NA,1), scm = NA, scm_init = NA) 
}
param_sc_hmc <- self_calib(generator, hyperparam, param_0, predictor, backend_hmc, tv, 10, 0, evolve_df, delivDir)

# test self-consistency for parameters_sc
datasets_sc <- generator(
  hyperparam = hyperparam,
  param = param_sc_hmc,
  predictor = predictor
)
result_sc <- compute_results(datasets_sc, backend_hmc) 
# before after compare with ecdf and rank summary
# graphical inspection
plot_rank_hist(result_25)
plot_rank_hist(result_sc)
```

```{r}
thin_ranks_v = 1
backend_vi <- SBC_backend_cmdstan_variational(mod_gr, output_samples = M, algorithm = "fullrank")
result_25_vi <- compute_results(datasets_25, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_vi)
result_22_vi <- compute_results(datasets_22, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_vi)
param_0 <- as_draws_rvars(subset_draws(datasets_22$parameters, variable = tv))
#target calibration
evolve_df <- list()
for (v in tv){
 evolve_df[[v]] <- list(median = rep(NA,1), sd = rep(NA,1), scm = NA, scm_init = NA) 
}
param_sc_vi <- self_calib(generator, hyperparam, param_0, predictor, backend_vi, tv, thin_ranks_v, 0, evolve_df, delivDir)

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  hyperparam = hyperparam,
  param = param_sc_vi,
  predictor = predictor
)
result_sc_vi <- compute_results(datasets_sc_vi, backend_vi, thin_ranks = thin_ranks_v) 

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  hyperparam = hyperparam,
  param = param_sc_vi,
  predictor = predictor
)
# before after compare with ecdf and rank summary
# graphical inspection
plot_rank_hist(result_25_vi)
plot_rank_hist(result_sc_vi)
```
