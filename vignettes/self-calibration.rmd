---
title: "self-calibration"
output: html_document
author: Hyunji Moon, Shinyoung Kim
---

```{r setup, include=FALSE}
library(SBC) #devtools::install_github("hyunjimoon/SBC")
library(cmdstanr)
library(parallel)
library(bayesplot)
library(posterior)
library(dplyr)
library(future)
library(ggpubr)
options(mc.cores = parallel::detectCores())
plan(multisession)
options(SBC.min_chunk_size = 5)
set.seed(1984)
devtools::load_all()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  include = TRUE,  cache = FALSE,  collapse = TRUE,  echo = TRUE,
  message = FALSE, tidy = FALSE,  warning = FALSE,   comment = "  ",
  dev = "png", dev.args = list(bg = '#FFFFF8'), dpi = 300,
  fig.align = "center",  fig.width = 7,  fig.asp = 0.618,  fig.show = "hold",
  out.width = "90%")
```

```{r  warning=FALSE}
#params: "a"   "b_1"... "b_15"  "shape"
generator <- function(hyperparam, param, predictor = NULL){
  # hyperparamter - constant or fixed distribution
  N = hyperparam$N
  shape = hyperparam$shape
  b = hyperparam$b
  # paramter - target, major distribution update
  a_loc = mean(param$a)
  a_scale = sd(param$a)
  a <- rvar(rnorm(S, a_loc, a_scale))
  # predictor
  X = predictor$X
  # generate
  mu = exp(a + X %**% b)
  Y <- rfun(rgamma) (n = N, shape = shape, scale = mu/shape) #k/theta = mean
  #rgamma(N, shape = shape, scale = scale)
  gen_rvars <- draws_rvars(N = N, Y = Y, K = K, X = X, a_loc = a_loc, a_scale = a_scale, shape = shape)
  # SBC reshape rvar<S>[1] distributed to each parallel simulation as rvar<1>[1]
  SBC_datasets(
    parameters = as_draws_matrix(param), 
    generated = draws_rvars_to_standata(gen_rvars)
  )
}

mod_gr = set_get_Dir("gamma-reg")$mod
```

HMC is underdispersed. ADVI is skewed to the right and has a tendency to under-estimate.

```{r  warning=FALSE}
S = 100
N = 30
M = 300
K = 15
chains = 4
hyperparam <- list(N = N, shape = 1, b = rvar_rng(rnorm, ndraws = S, n = K, 0, 1)) #rgamma(S, shape = 0.01, scale = 0.01)
#hyperparam <- list(N = N, shape = rvar_rng(rgamma, S, shape = 0.01, scale = 0.01), b = rvar_rng(rnorm, ndraws = S, n = K, 0, 1)) 
predictor <- draws_rvars(X = array(rnorm(S * N * K, mean = 1, sd = 1), dim = c(S, N, K)))
param_init_25 <- draws_rvars(a = rnorm(S, 2, 5)) # prior(normal(2, 2), class = "b", coef = "Intercept")
datasets_25 <- generator(
  hyperparam = hyperparam,
  param = param_init_25,
  predictor =  predictor
)
backend_hmc <- SBC_backend_cmdstan_sample(mod_gr, chains = chains, iter_sampling = M * 10 / chains)
backend_vi <- SBC_backend_cmdstan_variational(mod_gr, output_samples = M, algorithm = "fullrank")

result_25_hmc <- compute_results(datasets_25, backend_hmc)
result_25_vi <- compute_results(datasets_25, backend_vi, thin_ranks = 1)

plot_rank_hist(result_25_hmc)
plot_rank_hist(result_25_vi)
```

```{r  warning=FALSE}
param_22 <- draws_rvars(a = rvar(rnorm(S, 2, 2)))
datasets_22 <- generator(
  hyperparam = hyperparam,
  param = param_22,
  predictor = predictor
)
result_22 <- compute_results(datasets_22, backend_hmc)
plot_rank_hist(result_22)
result_22_vi <- compute_results(datasets_22, backend_vi, thin_ranks = 1)
plot_rank_hist(result_22_vi)
```

Can this trial and error search for SBC stabilizing prior (2,2) be found by automatically?
```{r warning=FALSE}
delivDir = set_get_Dir("gamma-reg")$delivDir
evolve_df <- list()
for (v in tv){
 evolve_df[[v]] <- list(median = rep(NA,1), sd = rep(NA,1), scm = NA, scm_init = NA) 
}
param_sc_hmc <- self_calib(generator, hyperparam, param_init_25, predictor, backend_hmc, tv, 10, 1, evolve_df, delivDir)
# test self-consistency for parameters_sc
datasets_sc <- generator(
  hyperparam = hyperparam,
  param = param_sc_hmc,
  predictor = predictor
)
result_sc <- compute_results(datasets_sc, backend_hmc) 
# before after compare with ecdf and rank summary
# graphical inspection
plot_rank_hist(result_25)
plot_rank_hist(result_sc)
```

```{r}
thin_ranks_v = 1
backend_vi <- SBC_backend_cmdstan_variational(mod_gr, output_samples = M, algorithm = "fullrank")
result_25_vi <- compute_results(datasets_25, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_25_vi)
result_22_vi <- compute_results(datasets_22, backend_vi, thin_ranks = thin_ranks_v)
plot_rank_hist(result_22_vi)
#target calibration
evolve_df <- list()
for (v in tv){
 evolve_df[[v]] <- list(median = rep(NA,1), sd = rep(NA,1), scm = NA, scm_init = NA) 
}
param_sc_vi <- self_calib(generator, hyperparam, param_init_25, predictor, backend_vi, tv, thin_ranks_v, 1, evolve_df, delivDir)

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  hyperparam = hyperparam,
  param = param_sc_vi,
  predictor = predictor
)
result_sc_vi <- compute_results(datasets_sc_vi, backend_vi, thin_ranks = thin_ranks_v) 

# test self-consistency for parameters_sc
datasets_sc_vi <- generator(
  hyperparam = hyperparam,
  param = param_sc_vi,
  predictor = predictor
)
# before after compare with ecdf and rank summary
# graphical inspection
plot_rank_hist(result_25_vi)
plot_rank_hist(result_sc_vi)
```
