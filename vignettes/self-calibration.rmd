---
title: "self-calibration"
author: "Hyunji Moon, Shinyoung Kim"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(SBC) #devtools::install_github("hyunjimoon/SBC")
library(cmdstanr)
library(parallel)
library(bayesplot)
library(posterior)
library(dplyr)
library(future)
library(ggpubr)
library(mclust)
options(mc.cores = parallel::detectCores())
plan(multisession)
options(SBC.min_chunk_size = 5)
set.seed(1984)
devtools::load_all()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  include = TRUE,  cache = FALSE,  collapse = TRUE,  echo = TRUE,
  message = FALSE, tidy = FALSE,  warning = FALSE,   comment = "  ",
  dev = "png", dev.args = list(bg = '#FFFFF8'), dpi = 300,
  fig.align = "center",  fig.width = 7,  fig.asp = 0.618,  fig.show = "hold",
  out.width = "90%")
```

```{r}
generator_gmm <- function(mixture_mean_draws_rvars, mixture_bw_draws_rvars, fixed_values){
  # fixed value across simulated datasets
  nobs <- fixed_values$nobs
  ndraws <- fixed_values$ndraws
  shape <- fixed_values$shape

  # predictor
  X = fixed_values$X
  # parameter with fixed distribution across `nsims` datasets
  b <- fixed_values$b 
  # target variable updated at each iteration
  a <- rvar_rng(rnorm, n = 1, sample(mixture_mean_draws_rvars$a, 1, replace=TRUE), sd=mixture_bw_draws_rvars$a)

  # generate
  mu = as.vector(exp(a + X %**% b))
  Y <- rvar_rng(rgamma, n = nobs, shape = shape, scale = mu / shape, ndraws = nsims)
  gen_rvars <- draws_rvars(nsims = nsims, nobs = nobs, npredictors = npredictors, 
                           shape = shape, X = X, 
                           mm_mean = mixture_mean_draws_rvars$a, mm_bandwidth = mixture_bw_draws_rvars$a, 
                           Y = Y)
  SBC_datasets(
    parameters = as_draws_matrix(list(a = a)), 
    generated = draws_rvars_to_standata(gen_rvars)
  )
}

nsims = 30
nobs = 100
ndraws = 1000
npredictors = 15
ntarget_params = 1
chains = 4
fixed_values <- list(nobs = nobs, ndraws = ndraws, shape = 1, 
                     b = rvar_rng(rnorm, ndraws = 1, n = npredictors, 0, 1), 
                     X = rvar(array(rnorm(n = nobs * npredictors, mean = 1, sd = 1), dim = c(1, nobs, npredictors))))

# proxy for target variable
mm_mean = draws_rvars(a = rvar(array(rep(rnorm(nsims, 2, 5), each = nsims), dim = c(nsims, nsims))))
mm_bandwidth = draws_rvars(a = rvar(array(rep(1, nsims), dim=c(nsims, 1))))

datasets_25 <- generator_gmm(
  mixture_mean_draws_rvars = mm_mean,
  mixture_bw_draws_rvars = mm_bandwidth,
  fixed_values = fixed_values
)

mod_gmm <- cmdstanr::cmdstan_model("./models/gamma-reg_gmm.stan")
backend_hmc_gmm <- SBC_backend_cmdstan_sample(mod_gmm, chains = chains, iter_sampling = ndraws / chains)
```

Starting from a bad SBC plot (first), better SBC plot (second) is found after three iterations.
```{r}
result_25_hmc <- compute_results(datasets_25, backend_hmc_gmm, thin_ranks = 3)
plot_rank_hist(result_25_hmc)

# self-calibrate
param_sc_hmc <- self_calib(generator_gmm, backend_hmc_gmm, mm_mean, mm_bandwidth, nsims_fn = function(...){nsims}, thin = 3, fixed_generator_args = list(fixed_values = fixed_values))
plot_rank_hist(param_sc_hmc)
```

For ADVI, $N(2,5^2)$ for the coefficient breaks in every case and therefore $N(2,1^2)$ is used. Notice as the self-consistent parameter region is a function of a generator and inference engine; prior $N(2,5^2)$ or $N(2,1^2)$ is simply used as an initial distribution. It remains to be seen whether different initial distribution converge to near enough region (near uniqueness). 

```{r}
mm_mean_21 = draws_rvars(a = rvar(array(rep(rnorm(nsims, 2, 1), each = nsims), dim = c(nsims, nsims))))
datasets_21 <- generator_gmm(
  mixture_mean_draws_rvars = mm_mean_21,
  mixture_bw_draws_rvars = mm_bandwidth,
  fixed_values = fixed_values
)

backend_vi <- SBC_backend_cmdstan_variational(mod_gmm, output_samples = ndraws, algorithm = "fullrank")
result_21_vi <- compute_results(datasets_21, backend_vi, thin_ranks = 1)
plot_rank_hist(result_21_vi)

# self-calibrate
param_sc_vi <- self_calib(generator_gmm, backend_vi, mm_mean_21, mm_bandwidth, nsims_fn = function(...){nsims}, thin = 1, fixed_generator_args = list(fixed_values = fixed_values))
plot_rank_hist(param_sc_vi)
```
