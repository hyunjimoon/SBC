<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBC with discrete parameters in Stan and JAGS • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SBC with discrete parameters in Stan and JAGS">
<meta property="og:description" content="SBC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SBC.html">Get Started</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="http://paul-buerkner.github.io/brms/" class="external-link">brms</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior" class="external-link">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/hyunjimoon/SBC" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SBC with discrete parameters in Stan and JAGS</h1>
                        <h4 data-toc-skip class="author">Martin Modrák</h4>
            
            <h4 data-toc-skip class="date">2022-02-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hyunjimoon/SBC/blob/HEAD/vignettes/discrete_vars.Rmd" class="external-link"><code>vignettes/discrete_vars.Rmd</code></a></small>
      <div class="hidden name"><code>discrete_vars.Rmd</code></div>

    </div>

    
    
<p>SBC was primarily designed for continuous parameters, but can be used with models that have discrete parameters - whether the parameters are directly represented (e.g. in BUGS/JAGS) or marginalized out (as is usual in Stan).</p>
<div class="section level2">
<h2 id="stan-version-and-debugging">Stan version and debugging<a class="anchor" aria-label="anchor" href="#stan-version-and-debugging"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hyunjimoon.github.io/SBC/">SBC</a></span><span class="op">)</span>; 
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="va">use_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"SBC.vignettes_cmdstanr"</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Set to false to use rstan instead</span>

<span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/cmdstanr/" class="external-link">cmdstanr</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span>
  <span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Multiprocessing support</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="co"># The fits are very fast and we fit just a few, </span>
<span class="co"># so we force a minimum chunk size to reduce overhead of</span>
<span class="co"># paralellization and decrease computation time.</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>SBC.min_chunk_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="co"># Setup caching of results</span>
<span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_discrete_vars_SBC_cache"</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_discrete_vars_rstan_SBC_cache"</span>
<span class="op">}</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We take the changepoint model from: <a href="https://mc-stan.org/docs/2_26/stan-users-guide/change-point-section.html" class="external-link uri">https://mc-stan.org/docs/2_26/stan-users-guide/change-point-section.html</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"stan/discrete_vars1.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code>data {
  real&lt;lower=0&gt; r_e;
  real&lt;lower=0&gt; r_l;

  int&lt;lower=1&gt; T;
  int&lt;lower=0&gt; y[T];
}
transformed data {
  real log_unif;
  log_unif = -log(T);
}
parameters {
  real&lt;lower=0&gt; e;
  real&lt;lower=0&gt; l;
}
transformed parameters {
  vector[T] lp;
  lp = rep_vector(log_unif, T);
  for (s in 1:T)
    for (t in 1:T)
      lp[s] = lp[s] + poisson_lpmf(y[t] | t &lt; s ? e : l);
}
model {
  e ~ exponential(r_e);
  l ~ exponential(r_l);
  target += log_sum_exp(lp);
}

generated quantities {
  int&lt;lower=1,upper=T&gt; s;
  s = categorical_logit_rng(lp);
}</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">model_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"stan/discrete_vars1.stan"</span><span class="op">)</span>
  <span class="va">backend_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_1</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">model_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"stan/discrete_vars1.stan"</span><span class="op">)</span>
  <span class="va">backend_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_1</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now, let’s generate data from the model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">generate_single_sim_1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">T</span>, <span class="va">r_e</span>, <span class="va">r_l</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">r_e</span><span class="op">)</span>
  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">r_l</span><span class="op">)</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="cn">T</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="cn">T</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="cn">T</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">t</span> <span class="op">&lt;=</span> <span class="va">s</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">rate</span> <span class="op">&lt;-</span> <span class="va">e</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">rate</span> <span class="op">&lt;-</span> <span class="va">l</span>
    <span class="op">}</span>
    <span class="va">y</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rate</span><span class="op">)</span> 
  <span class="op">}</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      e <span class="op">=</span> <span class="va">e</span>, l <span class="op">=</span> <span class="va">l</span>, s <span class="op">=</span> <span class="va">s</span>
    <span class="op">)</span>, generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      T <span class="op">=</span> <span class="cn">T</span>,
      r_e <span class="op">=</span> <span class="va">r_e</span>,
      r_l <span class="op">=</span> <span class="va">r_l</span>,
      y <span class="op">=</span> <span class="va">y</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">generator_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generate_single_sim_1</span>, T <span class="op">=</span> <span class="fl">5</span>, r_e <span class="op">=</span> <span class="fl">0.5</span>, r_l <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">85394672</span><span class="op">)</span>
<span class="va">datasets_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_1</span>, <span class="fl">30</span><span class="op">)</span></code></pre></div>
<p>Additionally, we’ll add a generated quantity expressing the total log-likelihood of data given the fitted parameters. The expression within the <code><a href="../reference/generated_quantities.html">generated_quantities()</a></code> call is evaluated for both prior and posterior draws and included as another variable in SBC checks. It turns out this type of generated quantities can increase the sensitivity of the SBC against some issues in the model. See <code><a href="../articles/limits_of_SBC.html">vignette("limits_of_SBC")</a></code> for a more detailed discussion of this.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">log_lik_gq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generated_quantities.html">generated_quantities</a></span><span class="op">(</span>log_lik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="cn">T</span> <span class="op">&lt;</span> <span class="va">s</span>, <span class="va">e</span>, <span class="va">l</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>So finally, lets actually compute SBC:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_1</span>, <span class="va">backend_1</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"model1"</span><span class="op">)</span>,
                    gen_quants <span class="op">=</span> <span class="va">log_lik_gq</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'model1'</span></code></pre>
<pre><code><span class="co">##  - 4 (13%) fits had at least one Rhat &gt; 1.01. Largest Rhat was NA.</span></code></pre>
<pre><code><span class="co">##  - 20 (67%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span>
<span class="co">## the rank statistics. The lowest tail ESS was NA.</span>
<span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span>
<span class="co">## or number of posterior draws (by refitting) might help.</span></code></pre>
<pre><code><span class="co">##  - 2 (7%) fits had divergent transitions. Maximum number of divergences was 3.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<p>Here we also use the caching feature to avoid recomputing the fits when recompiling this vignette. In practice, caching is not necessary but is often useful.</p>
<p>TODO the diagnostic failures are false positives, because Rhat and ESS don’t work very well for discrete parameters. We need to figure out how to handle this better.</p>
<p>We can quickly note that the statistics for the <code>s</code> parameter are extreme - many ranks of 0 and <em>extreme</em> z-scores, including -Infinity. Seing just one or two such fits should be enough to convince us that there is something fundamentally wrong.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">results_1</span><span class="op">$</span><span class="va">stats</span>, <span class="va">variable</span> <span class="op">==</span> <span class="st">"s"</span><span class="op">)</span> </code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 30 x 15</span></span>
<span class="co">##    sim_id variable simulated_value  rank   z_score  mean median    sd   mad</span>
<span class="co">##     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span>      1 s                      3   186    0.020<span style="text-decoration: underline;">0</span>  2.97      3 1.59   2.97</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span>      2 s                      1    24   -<span style="color: #BB0000;">1.90</span>    2.02      2 0.537  0   </span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span>      3 s                      4   126   -<span style="color: #BB0000;">1.37</span>    4.67      5 0.489  0   </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span>      4 s                      1    10   -<span style="color: #BB0000;">2.85</span>    2.86      3 0.651  0   </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span>      5 s                      5   397    2.76    2.86      3 0.775  0   </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span>      6 s                      2   290    0.118   1.84      1 1.35   0   </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span>      7 s                      3     0 -<span style="color: #BB0000;">Inf</span>       4         4 0      0   </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span>      8 s                      2   129   -<span style="color: #BB0000;">0.594</span>   2.87      3 1.46   1.48</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span>      9 s                      2     0   -<span style="color: #BB0000;">6.84</span>    2.99      3 0.144  0   </span>
<span class="co">## <span style="color: #BCBCBC;">10</span>     10 s                      2     3   -<span style="color: #BB0000;">8.68</span>    3.00      3 0.115  0   </span>
<span class="co">## <span style="color: #949494;"># ... with 20 more rows, and 6 more variables: q5 &lt;dbl&gt;, q95 &lt;dbl&gt;, rhat &lt;dbl&gt;,</span></span>
<span class="co">## <span style="color: #949494;">#   ess_bulk &lt;dbl&gt;, ess_tail &lt;dbl&gt;, max_rank &lt;int&gt;</span></span></code></pre>
<p>Inspecting the statistics shows that quite often, the model is quite sure of the value of <code>s</code> while the simulated value is just one less.</p>
<p>Looking at the <code>ecdf_diff</code> plot we see that this seems to compromise heavily the inference for <code>s</code>, but the other parameters do not show such bad behaviour. Note that the <code>log_lik</code> generated quantity shows even starker failure than <code>s</code>, so it indeed poses a stricter check in this scenario.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_1</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/results1_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_1</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/results1_plots-2.png" width="700"></p>
<p>An important note: you may wonder, how we got such a wiggly line for the <code>s</code> parameter - doesn’t it have just 5 possible values? Shouldn’t therefore the ECDF be one big staircase? In fact the package does a little trick to make discrete parameters comparable to continuous - the rank of a discrete parameter is chosen uniformly randomly across all possible ranks (i.e. posterior draws that have exactly equal value). This means that if the model is well behaved, ranks for the discrete parameter will be uniformly distributed across the whole range of possible ranks and we can use exactly the same diagnostics for a discrete parameter as we do for the continuous ones.</p>
<p>But back to the model - what happened? What is wrong with it? After some inspection, you may notice that the simulator does not match the model - the model takes the early rate (<code>e</code>) for points <code>t &lt; s</code> while the simulator takes <code>e</code> for points <code>t &lt;=  s</code>, so there is effectively a shift by one time point between the simulator and the model. So let’s assume that we beleive that the Stan model is in fact right. We therefore updated the simulator to match the model:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">generate_single_sim_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">T</span>, <span class="va">r_e</span>, <span class="va">r_l</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">r_e</span><span class="op">)</span>
  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">r_l</span><span class="op">)</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="cn">T</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="cn">T</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="cn">T</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="va">s</span><span class="op">)</span> <span class="op">{</span> <span class="co">### &lt;--- Only change here</span>
      <span class="va">rate</span> <span class="op">&lt;-</span> <span class="va">e</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">rate</span> <span class="op">&lt;-</span> <span class="va">l</span>
    <span class="op">}</span>
    <span class="va">y</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rate</span><span class="op">)</span> 
  <span class="op">}</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      e <span class="op">=</span> <span class="va">e</span>, l <span class="op">=</span> <span class="va">l</span>, s <span class="op">=</span> <span class="va">s</span>
    <span class="op">)</span>, generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      T <span class="op">=</span> <span class="cn">T</span>,
      r_e <span class="op">=</span> <span class="va">r_e</span>,
      r_l <span class="op">=</span> <span class="va">r_l</span>,
      y <span class="op">=</span> <span class="va">y</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">generator_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generate_single_sim_2</span>, T <span class="op">=</span> <span class="fl">5</span>, r_e <span class="op">=</span> <span class="fl">0.5</span>, r_l <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p>And we can recompute:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5846502</span><span class="op">)</span>
<span class="va">datasets_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_2</span>, <span class="fl">30</span><span class="op">)</span>
<span class="va">results_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_2</span>, <span class="va">backend_1</span>,
                    gen_quants <span class="op">=</span> <span class="va">log_lik_gq</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"model2"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'model2'</span></code></pre>
<pre><code><span class="co">##  - 8 (27%) fits had at least one Rhat &gt; 1.01. Largest Rhat was NA.</span></code></pre>
<pre><code><span class="co">##  - 24 (80%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span>
<span class="co">## the rank statistics. The lowest tail ESS was NA.</span>
<span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span>
<span class="co">## or number of posterior draws (by refitting) might help.</span></code></pre>
<pre><code><span class="co">##  - 2 (7%) fits had divergent transitions. Maximum number of divergences was 2.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_2</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/results_2_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_2</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/results_2_plots-2.png" width="700"></p>
<p>Looks good, so let us add some more simulations to make sure the model behaves well.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321488</span><span class="op">)</span>
<span class="va">datasets_2_more</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_2</span>, <span class="fl">100</span><span class="op">)</span>
<span class="va">results_2_more</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_2_more</span>, <span class="va">backend_1</span>,
                    gen_quants <span class="op">=</span> <span class="va">log_lik_gq</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"model3"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'model3'</span></code></pre>
<pre><code><span class="co">##  - 16 (16%) fits had at least one Rhat &gt; 1.01. Largest Rhat was NA.</span></code></pre>
<pre><code><span class="co">##  - 73 (73%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span>
<span class="co">## the rank statistics. The lowest tail ESS was NA.</span>
<span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span>
<span class="co">## or number of posterior draws (by refitting) might help.</span></code></pre>
<pre><code><span class="co">##  - 8 (8%) fits had divergent transitions. Maximum number of divergences was 20.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_2_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bind_results.html">bind_results</a></span><span class="op">(</span><span class="va">results_2</span>, <span class="va">results_2_more</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_2_all</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/results_2_all_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_2_all</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/results_2_all_plots-2.png" width="700"></p>
<p>Now - as far as this amount of SBC steps can see, the model is good and we get good behaviour for both the continuous and the discrete parameters and the <code>log_lik</code> generated quantity. Hooray!</p>
</div>
<div class="section level2">
<h2 id="jags-version">JAGS version<a class="anchor" aria-label="anchor" href="#jags-version"></a>
</h2>
<p>We can now write the same model in JAGS. This becomes a bit easier as JAGS lets us represent discrete parameters directly:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"other_models/changepoint.jags"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code>data {
  for(i in 1:T) {
    prior_s[i] = 1.0/T
  }
}

model {
  e ~ dexp(r_e);
  l ~ dexp(r_l);
  s ~ dcat(prior_s)
  for(i in 1:T) {
      y[i] ~ dpois(ifelse(i &lt; s, e, l))
  }
}</code></pre>
<p>We will use the <code>rjags</code> package - and relatively large number of samples as we can expect some autocorrelation in the Gibbs sampler.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">backend_jags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rjags.html">SBC_backend_rjags</a></span><span class="op">(</span><span class="st">"other_models/changepoint.jags"</span>,
                                  variable.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"e"</span>,<span class="st">"l"</span>,<span class="st">"s"</span><span class="op">)</span>,
                                  n.iter <span class="op">=</span> <span class="fl">10000</span>,
                                  n.burnin <span class="op">=</span> <span class="fl">1000</span>,
                                  n.chains <span class="op">=</span> <span class="fl">4</span>,
                                  thin <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>Running SBC with all the corrected datasets from before (rJAGS accepts input data in exactly the same format as Stan, so we can reuse the datasets without any change):</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">datasets_2_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bind_datasets.html">bind_datasets</a></span><span class="op">(</span><span class="va">datasets_2</span>, <span class="va">datasets_2_more</span><span class="op">)</span>
<span class="va">results_jags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_2_all</span>, <span class="va">backend_jags</span>,
                            gen_quants <span class="op">=</span> <span class="va">log_lik_gq</span>,
                        cache_mode <span class="op">=</span> <span class="st">"results"</span>,
                        cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"rjags"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'rjags'</span></code></pre>
<pre><code><span class="co">##  - 19 (15%) fits had at least one Rhat &gt; 1.01. Largest Rhat was NA.</span></code></pre>
<pre><code><span class="co">##  - 95 (73%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span>
<span class="co">## the rank statistics. The lowest tail ESS was NA.</span>
<span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span>
<span class="co">## or number of posterior draws (by refitting) might help.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<p>Similarly to the case above, the Rhat and ESS warnings are false positives due to the <code>s</code> parameter, which we need to handle better.</p>
<p>The rank plots show no problems.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_jags</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/ranks_jags-1.png" width="700"></p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_jags</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/ranks_jags-2.png" width="700"></p>
<p>As an exercise, we can also write the marginalized version of the model in JAGS. In some cases, marginalization improves performance even for JAGS models, however, for this model it is actually not an improvement, presumably because the model is very simple.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"other_models/changepoint_marginalized.jags"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></code></pre></div>
<pre><code>data {
  for(i in 1:T) {
    prior_unif[i] = -log(T)
  }

  # Using the zeroes crossing trick to compute the likelihood
  # See e.g. https://667-per-cm.net/2014/02/17/the-zero-crossings-trick-for-jags-finding-roots-stochastically/
  z = 0
}

model {
  e ~ dexp(r_e);
  l ~ dexp(r_l);

  # Prepare the zero trick
  z ~ dpois(z_mean)

  # Compute the likelihood
  # The lp is a matrix to avoid having to redefine nodes
  lp[1, 1:T] = prior_unif
  for (s in 1:T) {
    for (t in 1:T) {
      lp[1 + t, s] = lp[t, s] + log(ifelse(t &lt; s, e, l)) * y[t] - ifelse(t &lt; s, e, l)
    }
    p[s] = exp(lp[T + 1, s])
  }

  # log-sum-exp to compute the log likelihood in a numerically stable way
  m = max(lp[T + 1, ])
  sum_exp_rest[1] = 0
  for(t in 1:T) {
    sum_exp_rest[1 + t] = sum_exp_rest[t] + exp(lp[T + 1, s] - m)
  }
  lp_total = m + log(sum_exp_rest[T + 1])

  # We have the likelihood now add it to z_mean for the zeros trick
  z_mean = -lp_total + 10000

  s ~ dcat(p)
}</code></pre>
<p>The code got quite a bit more complex, se let’s check if we didn’t mess up the rewrite - first we build a backend with this new representation:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">backend_jags_marginalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rjags.html">SBC_backend_rjags</a></span><span class="op">(</span><span class="st">"other_models/changepoint_marginalized.jags"</span>,
                                  variable.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"e"</span>,<span class="st">"l"</span>,<span class="st">"s"</span><span class="op">)</span>,
                                  n.iter <span class="op">=</span> <span class="fl">10000</span>,
                                  n.burnin <span class="op">=</span> <span class="fl">1000</span>,
                                  n.chains <span class="op">=</span> <span class="fl">4</span>,
                                  thin <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>Then we run the actual SBC:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_jags_marginalized</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_2_all</span>, <span class="va">backend_jags_marginalized</span>,
                                         gen_quants <span class="op">=</span> <span class="va">log_lik_gq</span>,
                        cache_mode <span class="op">=</span> <span class="st">"results"</span>,
                        cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"rjags_marginalized"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'rjags_marginalized'</span></code></pre>
<pre><code><span class="co">##  - 24 (18%) fits had at least one Rhat &gt; 1.01. Largest Rhat was NA.</span></code></pre>
<pre><code><span class="co">##  - 95 (73%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span>
<span class="co">## the rank statistics. The lowest tail ESS was NA.</span>
<span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span>
<span class="co">## or number of posterior draws (by refitting) might help.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<p>And the ranks plots look good, so we indeed probably did succeed in correctly marginalizing the <code>s</code> parameter!</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_jags_marginalized</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/ranks_jags_marginalized-1.png" width="700"></p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_jags_marginalized</span><span class="op">)</span></code></pre></div>
<p><img src="discrete_vars_files/figure-html/ranks_jags_marginalized-2.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Shinyoung Kim, Hyunji Moon, Martin Modrák, Teemu Säilynoja.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
