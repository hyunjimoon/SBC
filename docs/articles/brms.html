<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBC for brms models • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SBC for brms models">
<meta property="og:description" content="SBC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SBC.html">Get Started</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="http://paul-buerkner.github.io/brms/" class="external-link">brms</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior" class="external-link">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/hyunjimoon/SBC" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SBC for brms models</h1>
                        <h4 data-toc-skip class="author">Martin Modrák</h4>
            
            <h4 data-toc-skip class="date">2022-02-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hyunjimoon/SBC/blob/HEAD/vignettes/brms.Rmd" class="external-link"><code>vignettes/brms.Rmd</code></a></small>
      <div class="hidden name"><code>brms.Rmd</code></div>

    </div>

    
    
<p>This vignette shows how the SBC package supports <code>brms</code> models. Let’s setup the environment:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hyunjimoon.github.io/SBC/">SBC</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="va">use_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"SBC.vignettes_cmdstanr"</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Set to false to use rstan instead</span>

<span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>brms.backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>brms.backend <span class="op">=</span> <span class="st">"rstan"</span><span class="op">)</span> 
  <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Using parallel processing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="co"># The fits are very fast,</span>
<span class="co"># so we force a minimum chunk size to reduce overhead of</span>
<span class="co"># paralellization and decrease computation time.</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>SBC.min_chunk_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="co"># Setup caching of results</span>
<span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_brms_SBC_cache"</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> 
  <span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_brms_rstan_SBC_cache"</span>
<span class="op">}</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="section level2">
<h2 id="generating-data-using-brms">Generating data using <code>brms</code><a class="anchor" aria-label="anchor" href="#generating-data-using-brms"></a>
</h2>
<p>The <code>brms</code> package has a built-in feature to simulate from prior corresponding to the model via the <code>sample_prior = "only"</code> option. This is a bit less useful in model validation as bug in <code>brms</code> (or any mismatch between what <code>brms</code> does and what we <em>think</em> it does) cannot be found as it will most likely affect the generator and the backend in the same way. Still this can be useful for validating <code>brms</code> itself - we’ll get to validation with custom generators in a while. For now, we’ll build a generator using <code>brms</code> directly.</p>
<p>Generating simulations with this generator requires us to compile a Stan model and may thus take a while. Also the exploration is often problematic, so to avoid problems, we take a lot of draws and thin the resulting draws heavily.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We need a "template dataset" to let brms build the model.</span>
<span class="co"># The predictor (x) values will be used for data generation,</span>
<span class="co"># the response (y) values will be ignored, but need to be present and </span>
<span class="co"># of the correct data type</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">213452</span><span class="op">)</span>
<span class="va">template_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span>
<span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span>
<span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_brms.html">SBC_generator_brms</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">template_data</span>, prior <span class="op">=</span> <span class="va">priors</span>, 
                                thin <span class="op">=</span> <span class="fl">50</span>, warmup <span class="op">=</span> <span class="fl">10000</span>, refresh <span class="op">=</span> <span class="fl">2000</span>,
                                <span class="co"># Will generate the log density - this is useful, </span>
                                <span class="co">#but a bit computationally expensive</span>
                                generate_lp <span class="op">=</span> <span class="cn">TRUE</span> 
                                <span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">22133548</span><span class="op">)</span>
<span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator</span>, <span class="fl">100</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Running MCMC with 1 chain...</span>
<span class="co">## </span>
<span class="co">## Chain 1 Iteration:     1 / 15000 [  0%]  (Warmup) </span>
<span class="co">## Chain 1 Iteration:  2000 / 15000 [ 13%]  (Warmup) </span>
<span class="co">## Chain 1 Iteration:  4000 / 15000 [ 26%]  (Warmup) </span>
<span class="co">## Chain 1 Iteration:  6000 / 15000 [ 40%]  (Warmup) </span>
<span class="co">## Chain 1 Iteration:  8000 / 15000 [ 53%]  (Warmup) </span>
<span class="co">## Chain 1 Iteration: 10000 / 15000 [ 66%]  (Warmup) </span>
<span class="co">## Chain 1 Iteration: 10001 / 15000 [ 66%]  (Sampling) </span>
<span class="co">## Chain 1 Iteration: 12000 / 15000 [ 80%]  (Sampling) </span>
<span class="co">## Chain 1 Iteration: 14000 / 15000 [ 93%]  (Sampling) </span>
<span class="co">## Chain 1 Iteration: 15000 / 15000 [100%]  (Sampling) </span>
<span class="co">## Chain 1 finished in 0.2 seconds.</span></code></pre>
<pre><code><span class="co">## Warning: Some rhats are &gt; 1.01 indicating the prior was not explored well.</span>
<span class="co">## The highest rhat is 1.02 for sigma</span>
<span class="co">## Consider adding warmup iterations (via 'warmup' argument).</span></code></pre>
<p>Now we’ll build a backend matching the generator (and reuse the compiled model from the generator)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_brms_from_generator.html">SBC_backend_brms_from_generator</a></span><span class="op">(</span><span class="va">generator</span>, chains <span class="op">=</span> <span class="fl">1</span>, thin <span class="op">=</span> <span class="fl">1</span>,
                            warmup <span class="op">=</span> <span class="fl">500</span>, iter <span class="op">=</span> <span class="fl">1500</span>,               
                            inits <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>

<span class="co"># More verbose alternative that results in exactly the same backend:</span>
<span class="co"># backend &lt;- SBC_backend_brms(y ~ x, template_data = template_data, prior = priors, warmup = 500, iter = 1000, chains = 1, thin = 1</span>
<span class="co">#                            init = 0.1)</span></code></pre></div>
<p>Compute the actual results</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets</span>, <span class="va">backend</span>,
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"first"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'first'</span></code></pre>
<pre><code><span class="co">##  - 14 (14%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.02.</span></code></pre>
<pre><code><span class="co">##  - 50 (50%) fits had some steps rejected. Maximum number of rejections was 1.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<p>There are some problems, that we currently choose to ignore (the highest Rhat is barely above the 1.01 threshold, so it is probably just noise in Rhat computation).</p>
<p>So we can inspect the rank plots. There are no big problems at this resolution.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_plots-2.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="using-custom-generator-code">Using custom generator code<a class="anchor" aria-label="anchor" href="#using-custom-generator-code"></a>
</h2>
<p>Let’s take a bit more complex model - with a single varying intercept.</p>
<p>This time we will not use the <code>brms</code> model to also simulate from prior, but simulate using an R function. This way, we get to learn if <code>brms</code> does what we think it does!</p>
<p>Custom generator code also allows us to have different covariate values for each simulation, potentially improving sensitivity if we want to check the model for a range of potential covariate values. If on the other hand we are interested in a specific dataset, it might make more sense to use the predictors as seen in the dataset in all simulations to focus our efforts on the dataset at hand.</p>
<p>Let’s take a Gaussian model with a single varying intercept.</p>
<p>The data can be generated using the following code - note that we need to be careful to match the parameter names as <code>brms</code> uses them. You can call <code>parnames</code> on a fit to see them.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">one_sim_generator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span>, <span class="va">K</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># N - number of datapoints, K number of groups for the varying intercept</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fl">3</span> <span class="op">*</span> <span class="va">K</span> <span class="op">&lt;=</span> <span class="va">N</span><span class="op">)</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span>
  
  <span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, size <span class="op">=</span> <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="co"># Ensure all groups are actually present at least twice</span>
  <span class="va">group</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">K</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>

  <span class="va">b_Intercept</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>   
  <span class="va">b_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  
  <span class="va">sd_group__Intercept</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>
  <span class="va">r_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">K</span>, <span class="fl">0</span>, <span class="va">sd_group__Intercept</span><span class="op">)</span>, 
                 nrow <span class="op">=</span> <span class="va">K</span>, ncol <span class="op">=</span> <span class="fl">1</span>,
                 dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="st">"Intercept"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">predictor</span> <span class="op">&lt;-</span> <span class="va">b_Intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">b_x</span> <span class="op">+</span> <span class="va">r_group</span><span class="op">[</span><span class="va">group</span><span class="op">]</span>
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">predictor</span>, <span class="va">sigma</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      b_Intercept <span class="op">=</span> <span class="va">b_Intercept</span>,
      b_x <span class="op">=</span> <span class="va">b_x</span>,
      sd_group__Intercept <span class="op">=</span> <span class="va">sd_group__Intercept</span>,
      r_group <span class="op">=</span> <span class="va">r_group</span>,
      sigma <span class="op">=</span> <span class="va">sigma</span>
    <span class="op">)</span>,
    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, group <span class="op">=</span> <span class="va">group</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">n_sims_generator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">one_sim_generator</span>, N <span class="op">=</span> <span class="fl">18</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<p>For increased sensitivity, we also add the log likelihood of the data given parameters as a generated quantity that we’ll also monitor (see the <a href="https://hyunjimoon.github.io/SBC/articles/limits_of_SBC.html"><code>limits_of_SBC</code></a> vignette for discussion on why this is useful).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">log_lik_gq_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generated_quantities.html">generated_quantities</a></span><span class="op">(</span>
  log_lik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">b_Intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">b_x</span> <span class="op">+</span> <span class="va">r_group</span><span class="op">[</span><span class="va">group</span><span class="op">]</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12239755</span><span class="op">)</span>
<span class="va">datasets_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">n_sims_generator</span>, <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p>This is then our <code>brms</code> backend - note that <code>brms</code> requires us to provide a dataset that it will use to build the model (e.g. to see how many levels of various varying intercepts to include):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">priors_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.75</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span>


<span class="va">backend_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_brms.html">SBC_backend_brms</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,  
                            prior <span class="op">=</span> <span class="va">priors_func</span>, chains <span class="op">=</span> <span class="fl">1</span>,
                            template_data <span class="op">=</span> <span class="va">datasets_func</span><span class="op">$</span><span class="va">generated</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>So we can happily compute:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_func</span>, <span class="va">backend_func</span>, 
                                gen_quants <span class="op">=</span> <span class="va">log_lik_gq_func</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"func"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'func'</span></code></pre>
<pre><code><span class="co">##  - 35 (35%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.113.</span></code></pre>
<pre><code><span class="co">##  - 6 (6%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span>
<span class="co">## the rank statistics. The lowest tail ESS was 25.</span>
<span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span>
<span class="co">## or number of posterior draws (by refitting) might help.</span></code></pre>
<pre><code><span class="co">##  - 44 (44%) fits had divergent transitions. Maximum number of divergences was 52.</span></code></pre>
<pre><code><span class="co">##  - 2 (2%) fits had iterations that saturated max treedepth. Maximum number of max treedepth was 465.</span></code></pre>
<pre><code><span class="co">##  - 78 (78%) fits had some steps rejected. Maximum number of rejections was 7.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<p>So that’s not looking good! Divergent transitions, Rhat problems… And the rank plots also show problems:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_func</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_func</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func_plots-2.png" width="700"></p>
<p>It looks like there is a problem affecting at least the <code>b_Intercept</code> and <code>sigma</code> variables. We may also notice that the <code>log_lik</code> (log likelihood derived from all the parameters) is copying the behaviour of the worst behaving variable. This tends to be the case in many models, so in models with lots of variables, it can be useful to add such a term as they make noticing problems easier.</p>
<p>What happened is that <code>brms</code> by default centers all the predictors, which changes the numerical values of the intercept (but not other terms). The interaction with the prior than probably also affects the other variables.</p>
<p>Maybe we don’t want <code>brms</code> to do this — using <code>0 + Intercept</code> syntax avoids the centering, so we build a new backend that should match our simulator better</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Using 0 + Intercept also changes how we need to specify priors</span>
<span class="va">priors_func2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.75</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span>


<span class="va">backend_func2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_brms.html">SBC_backend_brms</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,  
                            prior <span class="op">=</span> <span class="va">priors_func2</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, iter <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">1</span>,
                            template_data <span class="op">=</span> <span class="va">datasets_func</span><span class="op">$</span><span class="va">generated</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>Let’s fit the same simulations with the new backend.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_func2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_func</span>, <span class="va">backend_func2</span>, 
                                 gen_quants <span class="op">=</span> <span class="va">log_lik_gq_func</span>, 
                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, 
                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"func2"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Results loaded from cache file 'func2'</span></code></pre>
<pre><code><span class="co">##  - 22 (22%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.036.</span></code></pre>
<pre><code><span class="co">##  - 7 (7%) fits had divergent transitions. Maximum number of divergences was 7.</span></code></pre>
<pre><code><span class="co">##  - 1 (1%) fits had iterations that saturated max treedepth. Maximum number of max treedepth was 522.</span></code></pre>
<pre><code><span class="co">##  - 80 (80%) fits had some steps rejected. Maximum number of rejections was 9.</span></code></pre>
<pre><code><span class="co">## Not all diagnostics are OK.</span>
<span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span>
<span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></code></pre>
<p>We see that this still results in some problematic fits, but the proportion got lower. At this point I am honestly unsure what is the issue, but the rank plots look mostly OK:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_func2</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func2_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_func2</span><span class="op">)</span></code></pre></div>
<p><img src="brms_files/figure-html/results_func2_plots-2.png" width="700"></p>
<p>I promise to update this vignette once I figure out the source of the problems.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Shinyoung Kim, Hyunji Moon, Martin Modrák, Teemu Säilynoja.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
