<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Small model implementation workflow • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Small model implementation workflow">
<meta property="og:description" content="SBC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="hyunjimoon.github.io" src="https://plausible.io/js/script.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SBC.html">Get Started</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="http://paul-buerkner.github.io/brms/" class="external-link">brms</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior" class="external-link">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/hyunjimoon/SBC" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Small model implementation workflow</h1>
                        <h4 data-toc-skip class="author">Martin
Modrák</h4>
            
            <h4 data-toc-skip class="date">2023-01-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hyunjimoon/SBC/blob/HEAD/vignettes/small_model_workflow.Rmd" class="external-link"><code>vignettes/small_model_workflow.Rmd</code></a></small>
      <div class="hidden name"><code>small_model_workflow.Rmd</code></div>

    </div>

    
    
<p>Here we describe a complete process to iteratively build and validate
the <em>implementation</em> of a non-trivial, but still relatively small
model. This is not a full <a href="https://arxiv.org/abs/2011.01808" class="external-link">Bayesian Workflow</a>, instead
the process described here can be thought of as a subroutine in the full
workflow: here we take a relatively precise description of a model as
input and try to produce a Stan program that implements this model. Once
we have a Stan program we trust, it is still necessary to validate its
fit to actual data and other properties, which may trigger a need to
change the model. At this point you may want to go back to simulations
and make sure the modified model is implemented correctly.</p>
<p>The workflow described here focuses on small models. “Small” means
that the model is relatively fast to fit and we don’t have to worry
about computation too much. Once running ~100 fits of the model becomes
too costly, there are additional tricks and considerations that we hope
to delve into in a “Building a complex model” vignette (which currently
doesn’t exist). Still many of the approaches here also apply to complex
models (especially starting small and building smaller submodels
separately), and with proper separation of the model into submodels, one
can validate big chunks of Stan code while working with small models
only.</p>
<p>We expect the reader to be familiar with basics of the package. If
not, check out the <a href="https://hyunjimoon.github.io/SBC/articles/basic_usage.html">“basic_usage”
vignette</a>.</p>
<div class="section level2">
<h2 id="our-goal">Our goal<a class="anchor" aria-label="anchor" href="#our-goal"></a>
</h2>
<p>The example we’ll investigate is building a two-component Poisson
mixture, where the mixing ratio is allowed to vary with some predictors
while the means of the components are the same for all observations. A
somewhat contrived real world situation where this could be a useful
model: there are two sub-species of an animal that are hard to observe
directly, but leave droppings (poop) behind, that we can find. Further,
we know the subspecies differ in the average number of droppings they
leave at one place. So we can take the number of droppings as a noisy
information about which subspecie was present at given location. We
observe the number of droppings at multiple locations and record some
environmental covariates about the locations (e.g. temperature,
altitude) and want to learn something about the association between
those covariates and the prevalence of either subspecie.</p>
</div>
<div class="section level2">
<h2 id="big-picture">Big picture<a class="anchor" aria-label="anchor" href="#big-picture"></a>
</h2>
<p>This model naturally decomposes into two submodels:</p>
<ol style="list-style-type: decimal">
<li><p>the mixture submodel where the mixing ratio is the same for all
observations</p></li>
<li><p>a beta regression where we take covariates and make a prediction
of a probability, assuming we (noisily) observe the
probability.</p></li>
</ol>
<p>It is good practice to start small and implement and validate each of
those submodels separately and then put them together and validate the
bigger model. This makes is substantially easier to locate bugs. You’ll
notice that the process ends up involving a lot of steps, but the fact
is that we still ignore all the completely invalid models I created
while writing this vignette (typos, compile errors, dimension
mismatches, …). Developing models you can trust is hard work. More
experienced users can definitely make bigger steps at once, but we
strongly discourage anyone from writing a big model in one go. My
experience is that whenever I try to do this, the model breaks, is
impossible to debug and then I end up breaking it down anyway.</p>
<p>Let’s setup and get our hands dirty:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hyunjimoon.github.io/SBC/">SBC</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">use_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"SBC.vignettes_cmdstanr"</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Set to false to use rstan instead</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/cmdstanr/" class="external-link">cmdstanr</a></span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>SBC.min_chunk_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup caching of results</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_small_model_worklow_SBC_cache"</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_small_model_worklow_rstan_SBC_cache"</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mixture-submodel">Mixture submodel<a class="anchor" aria-label="anchor" href="#mixture-submodel"></a>
</h2>
<p>There is a good <a href="https://mc-stan.org/docs/2_27/stan-users-guide/mixture-modeling-chapter.html" class="external-link">guide
to mixtures</a> in the Stan user’s guide. Following the user’s guide
would save us from a lot of mistakes, but for the sake of example, we
will pretend we didn’t really read it - and we’ll see the problems can
be discovered via simulations.</p>
<p>So this is our first try at implementing the mixture submodel:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_first.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N;
  int y[N];
}

parameters {
  real mu1;
  real mu2;
  real&lt;lower=0, upper=1&gt; theta;
}

model {
  target += log_mix(theta, poisson_log_lpmf(y | mu1), poisson_log_lpmf(y | mu2));
  target += normal_lpdf(mu1 | 3, 1);
  target += normal_lpdf(mu2 | 3, 1);
}</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_first.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_first</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_first.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_first</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code></pre></div>
<p>And this is our code to simulate data for this model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator_func_first</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mu1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">mu2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      mu1 <span class="op">=</span> <span class="va">mu1</span>,</span>
<span>      mu2 <span class="op">=</span> <span class="va">mu2</span>,</span>
<span>      theta <span class="op">=</span> <span class="va">theta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="va">N</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generator_func_first</span>, N <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>Let’s start with just a single simulation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">68455554</span><span class="op">)</span></span>
<span><span class="va">datasets_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_first</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_first</span>, <span class="va">backend_first</span>, </span>
<span>                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"mixture_first"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'mixture_first'</span></span></code></pre>
<pre><code><span><span class="co">##  - 1 (100%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.717.</span></span></code></pre>
<pre><code><span><span class="co">##  - 1 (100%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span></span>
<span><span class="co">## the rank statistics. The lowest tail ESS was 129.</span></span>
<span><span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span></span>
<span><span class="co">## or number of posterior draws (by refitting) might help.</span></span></code></pre>
<pre><code><span><span class="co">##  - 1 (100%) fits had divergent transitions. Maximum number of divergences was 5.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>Oh, we have convergence problems, let us examine the pairs plots</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fixing the condition for above/over diagonal chains, in a minority</span></span>
<span><span class="co"># of runs the plot shows the problem less clearly, as discussed at</span></span>
<span><span class="co"># https://github.com/stan-dev/bayesplot/issues/132</span></span>
<span><span class="va">p_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">pairs_condition</a></span><span class="op">(</span>chains <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">results_first</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span>, condition <span class="op">=</span> <span class="va">p_cond</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">results_first</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, condition <span class="op">=</span> <span class="va">p_cond</span><span class="op">)</span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_first_convergence-1.png" width="700"></p>
<p>One thing that stands out is that either <code>mu1</code> is tightly
determined and <code>mu2</code> is allowed the full prior range or the
other way around. We also don’t learn anything about theta.</p>
<p>This might be puzzling but relates to bad usage of
<code>log_mix</code>. The thing is that
<code>poisson_log_lpmf(y | mu1)</code> returns a single number - the
total log likelihood of all elements of <code>y</code> given
<code>mu1</code>. And thus we are building a mixture where either all
observations are from the first component or all are from the second
component. To implement mixture where each observation is allowed to
come from a different component, we need to loop over observations and
do a separate <code>log_mix</code> call for each.</p>
<p>More details on the mathematical background are explained in the <a href="https://mc-stan.org/docs/2_27/stan-users-guide/vectorizing-mixtures.html" class="external-link">“Vectorizing
mixtures”</a> section of Stan User’s guide.</p>
<div class="section level3">
<h3 id="fixing-mixture">Fixing mixture<a class="anchor" aria-label="anchor" href="#fixing-mixture"></a>
</h3>
<p>So we’ve fixed the <code>log_mix</code> problem and this is our new
model:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_fixed_log_mix.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N;
  int y[N];
}

parameters {
  real mu1;
  real mu2;
  real&lt;lower=0, upper=1&gt; theta;
}

model {
  for(n in 1:N) {
    target += log_mix(theta,
                      poisson_log_lpmf(y[n] | mu1),
                      poisson_log_lpmf(y[n] | mu2));
  }
  target += normal_lpdf(mu1 | 3, 1);
  target += normal_lpdf(mu2 | 3, 1);
}</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_fixed_log_mix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_fixed_log_mix.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_fixed_log_mix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_fixed_log_mix</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_fixed_log_mix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_fixed_log_mix.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_fixed_log_mix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_fixed_log_mix</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>So let’s try once again with the same single simulation:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_fixed_log_mix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_first</span>, <span class="va">backend_fixed_log_mix</span>, </span>
<span>                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"mixture_fixed_log_mix"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'mixture_fixed_log_mix'</span></span></code></pre>
<pre><code><span><span class="co">##  - 1 (100%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.53.</span></span></code></pre>
<pre><code><span><span class="co">##  - 1 (100%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span></span>
<span><span class="co">## the rank statistics. The lowest tail ESS was 28.</span></span>
<span><span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span></span>
<span><span class="co">## or number of posterior draws (by refitting) might help.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>No warnings this time. We look at the stats:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_fixed_log_mix</span><span class="op">$</span><span class="va">stats</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 15</span></span></span>
<span><span class="co">##   sim_id variable simulated_value  rank z_score  mean median    sd    mad</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>      1 mu1               3.13     293   0.186 2.98  2.68   0.769 0.398 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>      1 mu2               4.27     344   0.587 3.83  4.25   0.743 0.026<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>      1 theta             0.052<span style="text-decoration: underline;">8</span>   223  -<span style="color: #BB0000;">0.542</span> 0.270 0.044<span style="text-decoration: underline;">9</span> 0.400 0.040<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">## <span style="color: #949494;"># … with 6 more variables: q5 &lt;dbl&gt;, q95 &lt;dbl&gt;, rhat &lt;dbl&gt;, ess_bulk &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ess_tail &lt;dbl&gt;, max_rank &lt;int&gt;</span></span></span></code></pre>
<p>We see nothing obviously wrong, the posterior means are relatively
close to simulated values (as summarised by the z-scores) - no variable
is clearly ridiculously misfit. So let’s run a few more iterations.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">8314566</span><span class="op">)</span></span>
<span><span class="va">datasets_first_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_first</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_fixed_log_mix_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_first_10</span>, <span class="va">backend_fixed_log_mix</span>, </span>
<span>                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"mixture_fixed_log_mix_2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'mixture_fixed_log_mix_2'</span></span></code></pre>
<pre><code><span><span class="co">##  - 10 (100%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.735.</span></span></code></pre>
<pre><code><span><span class="co">##  - 8 (80%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span></span>
<span><span class="co">## the rank statistics. The lowest tail ESS was 28.</span></span>
<span><span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span></span>
<span><span class="co">## or number of posterior draws (by refitting) might help.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>So there are some problems - we have quite a bunch of high R-hat and
low ESS values. This is the distribution of all rhats:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">results_fixed_log_mix_2</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">rhat</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_fixed_log_mix_rhat-1.png" width="700"></p>
<p>Let’s examine a single pairs plot:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">results_fixed_log_mix_2</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">results_fixed_log_mix_2</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_fixed_log_mix_pairs-1.png" width="700"></p>
<p>We clearly see two modes in the posterior. And upon reflection, we
can see why: swapping <code>mu1</code> with <code>mu2</code> while also
changing <code>theta</code> for <code>1 - theta</code> gives
<em>exactly</em> the same likelihood - because the ordering does not
matter. A more detailed explanation of this type of problem is at <a href="https://betanalpha.github.io/assets/case_studies/identifying_mixture_models.html" class="external-link uri">https://betanalpha.github.io/assets/case_studies/identifying_mixture_models.html</a></p>
</div>
<div class="section level3">
<h3 id="fixing-ordering">Fixing ordering<a class="anchor" aria-label="anchor" href="#fixing-ordering"></a>
</h3>
<p>We can easily fix the ordering of the <code>mu</code>s by using the
<code>ordered</code> built-in type.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_fixed_ordered.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N;
  int y[N];
}

parameters {
  ordered[2] mu;
  real&lt;lower=0, upper=1&gt; theta;
}

model {
  for(n in 1:N) {
    target += log_mix(theta,
                      poisson_log_lpmf(y[n] | mu[1]),
                      poisson_log_lpmf(y[n] | mu[2]));
  }
  target += normal_lpdf(mu | 3, 1);
}</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_fixed_ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_fixed_ordered.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_fixed_ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_fixed_ordered</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_fixed_ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/mixture_fixed_ordered.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_fixed_ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_fixed_ordered</span><span class="op">)</span>   </span>
<span><span class="op">}</span></span></code></pre></div>
<p>We also need to update the generator to match the new names and
ordering constant:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator_func_ordered</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># If the priors for all components of an ordered vector are the same</span></span>
<span>  <span class="co"># then just sorting the result of a generator is enough to create</span></span>
<span>  <span class="co"># a valid draw from the ordered vector prior</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      mu <span class="op">=</span> <span class="va">mu</span>,</span>
<span>      theta <span class="op">=</span> <span class="va">theta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="va">N</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator_ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generator_func_ordered</span>, N <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>We are kind of confident (and the model fits quickly), so we’ll
already start with 10 simulations.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3785432</span><span class="op">)</span></span>
<span><span class="va">datasets_ordered_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_ordered</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_fixed_ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_ordered_10</span>, <span class="va">backend_fixed_ordered</span>, </span>
<span>                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"mixture_fixed_ordered"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'mixture_fixed_ordered'</span></span></code></pre>
<pre><code><span><span class="co">##  - 2 (20%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.207.</span></span></code></pre>
<pre><code><span><span class="co">##  - 2 (20%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span></span>
<span><span class="co">## the rank statistics. The lowest tail ESS was 30.</span></span>
<span><span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span></span>
<span><span class="co">## or number of posterior draws (by refitting) might help.</span></span></code></pre>
<pre><code><span><span class="co">##  - 2 (20%) fits had divergent transitions. Maximum number of divergences was 145.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>Now some fits still produce problematic Rhats or divergent
transitions, let’s browse the <code>$backend_diagnostics</code> (which
contain Stan-specific diagnostic values) to see which simulations are
causing problems:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_fixed_ordered</span><span class="op">$</span><span class="va">backend_diagnostics</span></span></code></pre></div>
<pre><code><span><span class="co">##    sim_id max_chain_time n_failed_chains n_divergent n_max_treedepth n_rejects</span></span>
<span><span class="co">## 1       1          0.484               0           7               0         0</span></span>
<span><span class="co">## 2       2          0.777               0         145               0         0</span></span>
<span><span class="co">## 3       3          0.556               0           0               0         0</span></span>
<span><span class="co">## 4       4          0.501               0           0               0         0</span></span>
<span><span class="co">## 5       5          2.629               0           0               0         0</span></span>
<span><span class="co">## 6       6          0.665               0           0               0         0</span></span>
<span><span class="co">## 7       7          0.498               0           0               0         0</span></span>
<span><span class="co">## 8       8          0.455               0           0               0         0</span></span>
<span><span class="co">## 9       9          0.376               0           0               0         0</span></span>
<span><span class="co">## 10     10          0.374               0           0               0         0</span></span></code></pre>
<p>One of the fits has quite a lot of divergent transitions. Let’s look
at the pairs plot for the model:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">problematic_fit_id</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">problematic_fit</span> <span class="op">&lt;-</span> <span class="va">results_fixed_ordered</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="va">problematic_fit_id</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">problematic_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span>, np <span class="op">=</span> <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-extractors.html" class="external-link">nuts_params</a></span><span class="op">(</span><span class="va">problematic_fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">problematic_fit</span>, np <span class="op">=</span> <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-extractors.html" class="external-link">nuts_params</a></span><span class="op">(</span><span class="va">problematic_fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_fixed_ordered_pairs-1.png" width="700"></p>
<p>There is a lot of ugly stuff going on. Notably, one can notice that
the posterior of theta is bimodal, preferring either almost 0 or almost
1 - and when that happens, the mean of one of the components is almost
unconstrained. Why does that happen? The key to the answer is in the
simulated values for the component means:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/posterior/reference/subset_draws.html" class="external-link">subset_draws</a></span><span class="op">(</span><span class="va">datasets_ordered_10</span><span class="op">$</span><span class="va">variables</span>, draw <span class="op">=</span> <span class="va">problematic_fit_id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A draws_matrix: 1 iterations, 1 chains, and 3 variables</span></span>
<span><span class="co">##     variable</span></span>
<span><span class="co">## draw mu[1] mu[2] theta</span></span>
<span><span class="co">##    2   3.1   3.1  0.65</span></span></code></pre>
<p>We were unlucky enough to simulate data where both components have
almost the same mean and thus we are actually looking at data that is
not really a mixture. Mixture models can misbehave badly in such cases
(see once again the <a href="https://betanalpha.github.io/assets/case_studies/identifying_mixture_models.html#5_singular_components_and_computational_issues" class="external-link">case
study by Mike Betancourt</a> for a bit more detailed dive into this
particular problem).</p>
</div>
<div class="section level3">
<h3 id="fixing-degenerate-components">Fixing degenerate components?<a class="anchor" aria-label="anchor" href="#fixing-degenerate-components"></a>
</h3>
<p>What to do about this? Fixing the model to handle such cases
gracefully is hard. But the problem is basically our prior - we want to
express that (since we are fitting a two component model), we don’t
expect the means to be too similar. So if we can change our simulation
to avoid this, we’ll be able to proceed with SBC. If such a pattern
appeared in real data, we would still have a problem, but we would
notice thanks to the diagnostics.</p>
<p>This can definitely be done. But another way is to just ignore the
simulations that had divergences for SBC calculations. It turns out that
if we remove simulations in a way that only depends on the observed data
(and not on unobserved variables), the SBC identity is preserved and we
can use SBC without modifications. The resulting check is however
telling us something only for data that were not rejected. In this case
this is not a big issue: if a fit had divergent transitions, we would
not trust it anyway, so removing fits with divergent transitions is not
such a big deal.</p>
<p>For more details see the <a href="https://hyunjimoon.github.io/SBC/articles/rejection_sampling.html"><code>rejection_sampling</code></a>
vignette.</p>
<p>So let us subset the results to avoid divergences:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_ids_to_keep</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">results_fixed_ordered</span><span class="op">$</span><span class="va">backend_diagnostics</span><span class="op">$</span><span class="va">sim_id</span><span class="op">[</span></span>
<span>    <span class="va">results_fixed_ordered</span><span class="op">$</span><span class="va">backend_diagnostics</span><span class="op">$</span><span class="va">n_divergent</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Equivalent tidy version if you prefer</span></span>
<span><span class="co"># sim_ids_to_keep &lt;- results_fixed_ordered$backend_diagnostics %&gt;% </span></span>
<span><span class="co">#   dplyr::filter(n_divergent == 0) %&gt;%</span></span>
<span><span class="co">#   dplyr::pull(sim_id)</span></span>
<span></span>
<span></span>
<span><span class="va">results_fixed_ordered_subset</span> <span class="op">&lt;-</span> <span class="va">results_fixed_ordered</span><span class="op">[</span><span class="va">sim_ids_to_keep</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">results_fixed_ordered_subset</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## SBC_results with 8 total fits.</span></span>
<span><span class="co">##  - No fits had errors.</span></span>
<span><span class="co">##  - No fits gave warnings.</span></span>
<span><span class="co">##  - No fits had Rhat &gt; 1.01.</span></span>
<span><span class="co">##  - All fits had tail ESS &gt; half of the maximum rank.</span></span>
<span><span class="co">##  - The lowest bulk ESS was 1141</span></span>
<span><span class="co">##  - No fits had failed chains.</span></span>
<span><span class="co">##  - No fits had divergent transitions.</span></span>
<span><span class="co">##  - No fits had iterations that saturated max treedepth.</span></span>
<span><span class="co">##  - No fits had steps rejected.</span></span>
<span><span class="co">##  - Maximum time per chain was 2.629 sec.</span></span></code></pre>
<p>This gives us no obvious problems.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_fixed_ordered_subset</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_fixed_ordered_subset_results-1.png" width="700"></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_fixed_ordered_subset</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_fixed_ordered_subset_results-2.png" width="700"></p>
<p>Since we now have only 8 simulations, it is not surprising that we
are still left with a huge uncertainty about the actual coverage of our
posterior intervals - we can see that in a plot:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_coverage.html">plot_coverage</a></span><span class="op">(</span><span class="va">results_fixed_ordered_subset</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/mixture_fixed_ordered_subset_coverage-1.png" width="700"></p>
<p>The coverage plot shows the observed coverage of central posterior
intervals of varying width and the associated uncertainty (black +
grey), the blue line represents perfect calibration.</p>
<p>Or investigate numerically.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coverage</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empirical_coverage.html">empirical_coverage</a></span><span class="op">(</span><span class="va">results_fixed_ordered_subset</span><span class="op">$</span><span class="va">stats</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.9</span>,<span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">coverage</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 9 × 6</span></span></span>
<span><span class="co">##   variable width width_represented ci_low estimate ci_high</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> mu[1]     0.5               0.5   0.299    0.625   0.863</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> mu[1]     0.9               0.9   0.518    0.875   0.972</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> mu[1]     0.95              0.95  0.518    0.875   0.972</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> mu[2]     0.5               0.5   0.400    0.75    0.925</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> mu[2]     0.9               0.9   0.518    0.875   0.972</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> mu[2]     0.95              0.95  0.518    0.875   0.972</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span> theta     0.5               0.5   0.137    0.375   0.701</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">8</span> theta     0.9               0.9   0.400    0.75    0.925</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">9</span> theta     0.95              0.95  0.400    0.75    0.925</span></span></code></pre>
<p>We can clearly see that while there are no terrible errors, a quite
big miscalibration is still consistent with the SBC results so far, for
example the 90% posterior interval for <code>theta</code> could (as far
as we know) contain 40% - 93% of the true values. That’s not very
reassuring.</p>
<p>So we can run for more iterations - to reduce memory consumption, we
set <code>keep_fits = FALSE</code>. You generally don’t want to do this
unless you are really short on memory, as it makes you unable to inspect
any problems in your fits:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54987622</span><span class="op">)</span></span>
<span><span class="va">datasets_ordered_100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_ordered</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">results_fixed_ordered_100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_ordered_100</span>, <span class="va">backend_fixed_ordered</span>, </span>
<span>                    keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"mixture_fixed_ordered_100"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'mixture_fixed_ordered_100'</span></span></code></pre>
<pre><code><span><span class="co">##  - 19 (19%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.354.</span></span></code></pre>
<pre><code><span><span class="co">##  - 21 (21%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span></span>
<span><span class="co">## the rank statistics. The lowest tail ESS was 11.</span></span>
<span><span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span></span>
<span><span class="co">## or number of posterior draws (by refitting) might help.</span></span></code></pre>
<pre><code><span><span class="co">##  - 28 (28%) fits had divergent transitions. Maximum number of divergences was 182.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>Once again we subset to keep only non-divergent fits - this also
removes all the problematic Rhats and ESS.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_ids_to_keep</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">results_fixed_ordered_100</span><span class="op">$</span><span class="va">backend_diagnostics</span><span class="op">$</span><span class="va">sim_id</span><span class="op">[</span></span>
<span>    <span class="va">results_fixed_ordered_100</span><span class="op">$</span><span class="va">backend_diagnostics</span><span class="op">$</span><span class="va">n_divergent</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Equivalent tidy version</span></span>
<span><span class="co"># sim_ids_to_keep &lt;- results_fixed_ordered_100$backend_diagnostics %&gt;% </span></span>
<span><span class="co">#   dplyr::filter(n_divergent == 0) %&gt;%</span></span>
<span><span class="co">#   dplyr::pull(sim_id)</span></span>
<span></span>
<span></span>
<span><span class="va">results_fixed_ordered_100_subset</span> <span class="op">&lt;-</span> <span class="va">results_fixed_ordered_100</span><span class="op">[</span><span class="va">sim_ids_to_keep</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">results_fixed_ordered_100_subset</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## SBC_results with 72 total fits.</span></span>
<span><span class="co">##  - No fits had errors.</span></span>
<span><span class="co">##  - No fits gave warnings.</span></span>
<span><span class="co">##  - No fits had Rhat &gt; 1.01.</span></span>
<span><span class="co">##  - All fits had tail ESS &gt; half of the maximum rank.</span></span>
<span><span class="co">##  - The lowest bulk ESS was 507</span></span>
<span><span class="co">##  - No fits had failed chains.</span></span>
<span><span class="co">##  - No fits had divergent transitions.</span></span>
<span><span class="co">##  - No fits had iterations that saturated max treedepth.</span></span>
<span><span class="co">##  - No fits had steps rejected.</span></span>
<span><span class="co">##  - Maximum time per chain was 4.316 sec.</span></span></code></pre>
<p>And we can use <code>bind_results</code> to combine the new results
with the previous fits to not waste our computational effort.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_fixed_ordered_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bind_results.html">bind_results</a></span><span class="op">(</span></span>
<span>  <span class="va">results_fixed_ordered_subset</span>, <span class="va">results_fixed_ordered_100_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_fixed_ordered_combined</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_fixed_ordered_combined_results-1.png" width="700"></p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_fixed_ordered_combined</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_fixed_ordered_combined_results-2.png" width="700"></p>
<p>Seems fairly well within the expected bounds. We could definitely run
more iterations if we wanted to have a more strict check, but for now,
we are happy and the remaining uncertainty about the coverage of our
posterior intervals is no longer huge, so it is highly unlikely there is
some big bug lurking down there. While we see a potential problem where
the coverage for <code>mu[1]</code> and <code>mu[2]</code> is no longer
consistent with perfect calibration, the <code>ecdf_diff</code> plot
takes precedence as the uncertainty in the coverage plot is only
approximate and we thus cannot take it too seriously (see
<code><a href="../reference/empirical_coverage.html">help("empirical_coverage")</a></code> for some more details).</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_coverage.html">plot_coverage</a></span><span class="op">(</span><span class="va">results_fixed_ordered_combined</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_fixed_ordered_combined_results_coverage-1.png" width="700"></p>
<p>Note: it turns out that extending the model to more components
becomes somewhat tricky as the model can become sensitive to
initialization. Also the problems with data that can be explained by
fewer components than the model assumes become more prevalent.</p>
</div>
</div>
<div class="section level2">
<h2 id="beta-regression-submodel">Beta regression submodel<a class="anchor" aria-label="anchor" href="#beta-regression-submodel"></a>
</h2>
<p>Let’s move to the beta regression submodel of our model. After
spending a bunch of time implementing this, I realized, that maybe
treating this as a logistic regression submodel would have been wiser
(and sufficient). But I am gonna keep it in - it just demonstrates that
a real workflow can be messy and let’s us show some additional classes
of problems and how they manifest in SBC.</p>
<p>Checking the wiki page for Beta distribution, we notice that it has
two parameters, both bounded to be positive. So our first attempt at
beta regression just creates two linear predictors - one for each
parameter of the distribution. We then exponentiate the predictors to
make them positive and we have a model:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_first.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N_obs;
  vector&lt;lower=0, upper=1&gt;[N_obs] y;

  int&lt;lower=1&gt; N_predictors;
  matrix[N_predictors, N_obs] x;
}

parameters {
  matrix[2, N_predictors] beta;
}

model {
  matrix[2, N_obs] linpred = beta * x;
  target += beta_lpdf(y | exp(linpred[1,]), exp(linpred[2,]));
  target += normal_lpdf(to_vector(beta) | 0, 1);
}</code></pre>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_beta_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_first.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_beta_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_beta_first</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_beta_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_first.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_beta_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_beta_first</span><span class="op">)</span>   </span>
<span><span class="op">}</span></span></code></pre></div>
<p>We also write a matching generator (microoptimization tip: I usually
write Stan models first so that I can work on the generator code while
the Stan model compiles):</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator_func_beta_first</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N_obs</span>, <span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">repeat</span> <span class="op">{</span></span>
<span>    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span> <span class="op">*</span> <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="va">N_predictors</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span> <span class="op">*</span> <span class="va">N_obs</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">N_predictors</span>, ncol <span class="op">=</span> <span class="va">N_obs</span><span class="op">)</span></span>
<span>    <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># Intercept</span></span>
<span>  </span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="va">N_obs</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">linpred</span><span class="op">[</span><span class="va">c</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">linpred</span><span class="op">[</span><span class="va">c</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">p</span>, <span class="va">n</span><span class="op">]</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="va">c</span>, <span class="va">p</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">linpred</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">linpred</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;</span> <span class="fl">1</span> <span class="op">-</span> <span class="fl">1e-12</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">break</span>;</span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>    </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="va">beta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N_obs <span class="op">=</span> <span class="va">N_obs</span>,</span>
<span>      N_predictors <span class="op">=</span> <span class="va">N_predictors</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span>,</span>
<span>      x <span class="op">=</span> <span class="va">x</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator_beta_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generator_func_beta_first</span>, N_obs <span class="op">=</span> <span class="fl">50</span>, N_predictors <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>One thing to note is that we add a rejection sampling step - we
repeatedly generate simulations, until we find one without
<code>y</code> values very close to 1. Those can be problematic as they
can be rounded to 1 when the data for Stan is written to disk. And exact
1 is impossible with the Beta likelihood and the model will fail.
Rejecting the simulation due to this criterion is quite rare and in
fact, it does not threaten the validity of the SBC procedure (at least
to the extent our real data also don’t contain such extreme values) -
for more details see the <a href="https://hyunjimoon.github.io/SBC/articles/rejection_sampling.html"><code>rejection_sampling</code></a>
vignette.</p>
<p>We’ll start with 10 simulations once again.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3325488</span><span class="op">)</span></span>
<span><span class="va">datasets_beta_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_beta_first</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_beta_first_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_beta_first</span>, <span class="va">backend_beta_first</span>, </span>
<span>                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"beta_first_10"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'beta_first_10'</span></span></code></pre>
<pre><code><span><span class="co">##  - 1 (10%) fits had divergent transitions. Maximum number of divergences was 7.</span></span></code></pre>
<pre><code><span><span class="co">##  - 10 (100%) fits had some steps rejected. Maximum number of rejections was 26.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>We get a single fit with divergent transitions and the ranks look
mostly OK:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_beta_first_10</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/beta_first_results-1.png" width="700"></p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_beta_first_10</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/beta_first_results-2.png" width="700"></p>
<p>Let’s inspect the pairs plot for the offending fit:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">results_beta_first_10</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">results_beta_first_10</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/beta_first_10_pairs-1.png" width="700"></p>
<p>This is a very crowded plot and it is hard to resolve details, but we
see some correlations between the corresponding beta elements
(e.g. <code>beta[1,1]</code> and <code>beta[2,1]</code>), let’s have a
closer look and show the same pairs plot for five of our fits:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">results_beta_first_10</span><span class="op">$</span><span class="va">fits</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pairs_input</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">pairs_input</span> <span class="op">&lt;-</span> <span class="va">fit</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">pairs_input</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta[1,1]"</span>, <span class="st">"beta[2,1]"</span>,<span class="st">"beta[1,2]"</span>, <span class="st">"beta[2,2]"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/beta_first_10_pairs_subset-1.png" width="700"><img src="small_model_workflow_files/figure-html/beta_first_10_pairs_subset-2.png" width="700"><img src="small_model_workflow_files/figure-html/beta_first_10_pairs_subset-3.png" width="700"><img src="small_model_workflow_files/figure-html/beta_first_10_pairs_subset-4.png" width="700"><img src="small_model_workflow_files/figure-html/beta_first_10_pairs_subset-5.png" width="700"></p>
<p>Turns out the correlations are in all fits, although sometimes they
are relatively weak and the sampler is able to handle the posterior, it
is potentially troubling. The main issue is that we plan to integrate
this model with other submodels and problems that can be tolerated in a
single submodel might interact with other submodels and make the model
intractable.</p>
<p>We can even understand the reason for the positive correlation - it
is because predicted means of our response beta distribution is the
<code>exp(linpred[1,]) / ( exp(linpred[1,]) + exp(linpred[2,]))</code>
vector. Increasing both linear predictors by the same amount results in
the same predicted means for all elemntes of <code>x</code> (but
different predicted variances). And changing the two corresponding
<code>beta</code> elements has exactly this effect - the two linear
predictor for any <code>x</code> increase by the same amount. In this
case, the mean is more constrained than variance of the response, so the
individual predictor values for the first shape parameter are allowed to
vary quite a bit as long as their counterpart for the second shape
parameter increases as well, keeping the predicted mean the same and
showing our uncertainty about the variance. And this is how we get this
ridge.</p>
<div class="section level3">
<h3 id="parametrizing-the-beta-distribution-via-mean">Parametrizing the beta distribution via mean<a class="anchor" aria-label="anchor" href="#parametrizing-the-beta-distribution-via-mean"></a>
</h3>
<p>The simplest way to resolve the issue with the correlations is to
explicitly parametrize the beta distribution by its mean (<span class="math inline">\(0 &lt; \mu &lt; 1\)</span>). The more common
parametrization then adds a precision parameter (<span class="math inline">\(\phi &gt; 0\)</span>), so we then have <span class="math inline">\(y \sim \mathrm{Beta}(\mu \phi, (1 - \mu)
\phi)\)</span></p>
<p>This also makes much more sense for the bigger task - combining with
the mixture submodel, as we really want to predict just a single
probability. So we’ll rewrite our predictors to predict only the logit
of the mean (as in logistic regression) and keep the precision as a
constant between observations. We could definitely also decide whether
to keep the full flexibility and allow predictors for precision, we just
don’t do it here.</p>
<p>This is then our updated model:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_precision.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N_obs;
  vector&lt;lower=0, upper=1&gt;[N_obs] y;

  int&lt;lower=1&gt; N_predictors;
  matrix[N_predictors, N_obs] x;
}

parameters {
  vector[N_predictors] beta;
  real&lt;lower=0&gt; phi;
}

model {
  vector[N_obs] mu = inv_logit(transpose(x) * beta);

  target += beta_lpdf(y | mu * phi, (1 - mu) * phi);
  target += normal_lpdf(beta | 0, 1);
}</code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_beta_precision</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_precision.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_beta_precision</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_beta_precision</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_beta_precision</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_precision.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_beta_precision</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_beta_precision</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>And we need to update the generator to match:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator_func_beta_precision</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N_obs</span>, <span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">repeat</span> <span class="op">{</span></span>
<span>    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span> <span class="op">*</span> <span class="va">N_obs</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">N_predictors</span>, ncol <span class="op">=</span> <span class="va">N_obs</span><span class="op">)</span></span>
<span>    <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># Intercept</span></span>
<span>  </span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="va">N_obs</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="va">linpred</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">p</span>, <span class="va">n</span><span class="op">]</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="va">p</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">linpred</span><span class="op">)</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span> <span class="op">*</span> <span class="va">phi</span>, <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span> <span class="op">*</span> <span class="va">phi</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;</span> <span class="fl">1</span> <span class="op">-</span> <span class="fl">1e-12</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">break</span>;</span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>    </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="va">beta</span>,</span>
<span>      phi <span class="op">=</span> <span class="va">phi</span></span>
<span>    <span class="op">)</span>,</span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N_obs <span class="op">=</span> <span class="va">N_obs</span>,</span>
<span>      N_predictors <span class="op">=</span> <span class="va">N_predictors</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span>,</span>
<span>      x <span class="op">=</span> <span class="va">x</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator_beta_precision</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generator_func_beta_precision</span>, N_obs <span class="op">=</span> <span class="fl">50</span>, N_predictors <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>Starting with 10 simulations:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">46988234</span><span class="op">)</span></span>
<span><span class="va">datasets_beta_precision_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_beta_precision</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_beta_precision_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_beta_precision_10</span>, <span class="va">backend_beta_precision</span>, </span>
<span>                    cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"beta_precision_10"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'beta_precision_10'</span></span></code></pre>
<pre><code><span><span class="co">##  - 10 (100%) fits had some steps rejected. Maximum number of rejections was 13.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>No big problems from the fit and the plots:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_beta_precision_10</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_10_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_beta_precision_10</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_10_plots-2.png" width="700"></p>
<p>So we’ll run 90 more iterations and combine them with the previous
results:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2136468</span><span class="op">)</span></span>
<span><span class="va">datasets_beta_precision_90</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_beta_precision</span>, <span class="fl">90</span><span class="op">)</span></span>
<span><span class="va">results_beta_precision_90</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span></span>
<span>  <span class="va">datasets_beta_precision_90</span>, <span class="va">backend_beta_precision</span>,</span>
<span>  keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>  cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"beta_precision_90"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'beta_precision_90'</span></span></code></pre>
<pre><code><span><span class="co">##  - 90 (100%) fits had some steps rejected. Maximum number of rejections was 22.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_beta_precision_100</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bind_results.html">bind_results</a></span><span class="op">(</span></span>
<span>    <span class="va">results_beta_precision_10</span>,</span>
<span>    <span class="va">results_beta_precision_90</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="va">datasets_beta_precision_100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bind_datasets.html">bind_datasets</a></span><span class="op">(</span><span class="va">datasets_beta_precision_10</span>, <span class="va">datasets_beta_precision_90</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_beta_precision_100</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_100_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_beta_precision_100</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_100_plots-2.png" width="700"></p>
<p>The plots don’t look terrible, but the <code>beta[2]</code> and
especially the <code>phi</code> variable show slight problems.</p>
<p>So we look back at our model code and note that we forgot to put any
prior on <code>phi</code>! Mismatches in priors between the model and
the simulator are unfortunately often not very well visible for SBC and
can require a lot of simulations to discover (see the <a href="https://hyunjimoon.github.io/SBC/articles/limits_of_SBC.html"><code>limits_of_SBC</code></a>
vignette for more detailed discussion)</p>
</div>
<div class="section level3">
<h3 id="adding-missing-prior">Adding missing prior<a class="anchor" aria-label="anchor" href="#adding-missing-prior"></a>
</h3>
<p>So we add the missing prior to the model:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_precision_fixed_prior.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N_obs;
  vector&lt;lower=0, upper=1&gt;[N_obs] y;

  int&lt;lower=1&gt; N_predictors;
  matrix[N_predictors, N_obs] x;
}

parameters {
  vector[N_predictors] beta;
  real&lt;lower=0&gt; phi;
}

model {
  vector[N_obs] mu = inv_logit(transpose(x) * beta);

  target += beta_lpdf(y | mu * phi, (1 - mu) * phi);
  target += normal_lpdf(beta | 0, 1);
  target += lognormal_lpdf(phi | 3, 1);
}</code></pre>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_beta_precision_fixed_prior</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_precision_fixed_prior.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_beta_precision_fixed_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_beta_precision_fixed_prior</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_beta_precision_fixed_prior</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/beta_precision_fixed_prior.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_beta_precision_fixed_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_beta_precision_fixed_prior</span><span class="op">)</span>   </span>
<span><span class="op">}</span></span></code></pre></div>
<p>And recompute for all 100 simulations at once (as we don’t expect
adding prior to introduce huge problems).</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_beta_precision_fixed_prior</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_beta_precision_100</span>, <span class="va">backend_beta_precision_fixed_prior</span>, </span>
<span>                    keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"beta_precision_fixed_prior"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'beta_precision_fixed_prior'</span></span></code></pre>
<pre><code><span><span class="co">##  - 100 (100%) fits had some steps rejected. Maximum number of rejections was 18.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_beta_precision_fixed_prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_fixed_prior_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_beta_precision_fixed_prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_fixed_prior_plots-2.png" width="700"></p>
<p>Diagnostic plots are looking good! So we add 100 more
simulations:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1233845</span><span class="op">)</span></span>
<span><span class="va">datasets_beta_precision_100b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_beta_precision</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">results_beta_precision_fixed_prior_200</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bind_results.html">bind_results</a></span><span class="op">(</span></span>
<span>    <span class="va">results_beta_precision_fixed_prior</span>,</span>
<span>    <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">datasets_beta_precision_100b</span>, <span class="va">backend_beta_precision_fixed_prior</span>, </span>
<span>                    keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"beta_precision_fixed_prior_2"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'beta_precision_fixed_prior_2'</span></span></code></pre>
<pre><code><span><span class="co">##  - 100 (100%) fits had some steps rejected. Maximum number of rejections was 17.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_beta_precision_fixed_prior_200</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_fixed_prior_200_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_beta_precision_fixed_prior_200</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_fixed_prior_200_plots-2.png" width="700"></p>
<p>Yeah, still looking good. And we can see that the empirical coverage
of our central intervals is in quite tight agreement with theory:</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_coverage.html">plot_coverage</a></span><span class="op">(</span><span class="va">results_beta_precision_fixed_prior_200</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_beta_precision_fixed_prior_200_coverage-1.png" width="700"></p>
<p>So for now we are also happy about the beta regression submodel.</p>
</div>
</div>
<div class="section level2">
<h2 id="putting-it-together">Putting it together<a class="anchor" aria-label="anchor" href="#putting-it-together"></a>
</h2>
<p>We are finally ready to make a first attempt at the full model:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"small_model_workflow/combined_first.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower=0&gt; N_obs;
  int y[N_obs];

  int&lt;lower=1&gt; N_predictors;
  matrix[N_predictors, N_obs] x;
}

parameters {
  ordered[2] mu;

  vector[N_predictors] beta;
}

model {
  vector[N_obs] theta = inv_logit(transpose(x) * beta);


  for(n in 1:N_obs) {
    target += log_mix(theta[n],
                      poisson_log_lpmf(y[n] | mu[1]),
                      poisson_log_lpmf(y[n] | mu[2]));
  }
  target += normal_lpdf(mu | 3, 1);
  target += normal_lpdf(beta | 0, 1);
}</code></pre>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/combined_first.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span><span class="va">model_combined</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">model_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"small_model_workflow/combined_first.stan"</span><span class="op">)</span></span>
<span>  <span class="va">backend_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">model_combined</span><span class="op">)</span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>And this is our generator for the full model:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator_func_combined</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N_obs</span>, <span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># If the priors for all components of an ordered vector are the same</span></span>
<span>  <span class="co"># then just sorting the result of a generator is enough to create</span></span>
<span>  <span class="co"># a valid draw from the ordered vector prior</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span> <span class="op">*</span> <span class="va">N_obs</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">N_predictors</span>, ncol <span class="op">=</span> <span class="va">N_obs</span><span class="op">)</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># Intercept</span></span>
<span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="va">N_obs</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="va">linpred</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">p</span>, <span class="va">n</span><span class="op">]</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="va">p</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">linpred</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="va">beta</span>,</span>
<span>      mu <span class="op">=</span> <span class="va">mu</span></span>
<span>    <span class="op">)</span>,</span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N_obs <span class="op">=</span> <span class="va">N_obs</span>,</span>
<span>      N_predictors <span class="op">=</span> <span class="va">N_predictors</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span>,</span>
<span>      x <span class="op">=</span> <span class="va">x</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generator_func_combined</span>, N_obs <span class="op">=</span> <span class="fl">50</span>, N_predictors <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>We are confident (and the fits are fast anyway), so we start with 200
simulations:</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5749955</span><span class="op">)</span></span>
<span><span class="va">dataset_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_combined</span>, <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">dataset_combined</span>, <span class="va">backend_combined</span>, </span>
<span>                    keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"combined"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'combined'</span></span></code></pre>
<pre><code><span><span class="co">##  - 10 (5%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.417.</span></span></code></pre>
<pre><code><span><span class="co">##  - 12 (6%) fits had tail ESS undefined or less than half of the maximum rank, potentially skewing </span></span>
<span><span class="co">## the rank statistics. The lowest tail ESS was 10.</span></span>
<span><span class="co">##  If the fits look good otherwise, increasing `thin_ranks` (via recompute_SBC_statistics) </span></span>
<span><span class="co">## or number of posterior draws (by refitting) might help.</span></span></code></pre>
<pre><code><span><span class="co">##  - 19 (10%) fits had divergent transitions. Maximum number of divergences was 213.</span></span></code></pre>
<pre><code><span><span class="co">##  - 3 (2%) fits had some steps rejected. Maximum number of rejections was 2.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>We get some amount of divergent transitions, but the ranks look
pretty good:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_combined</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_combined_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_combined</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_combined_plots-2.png" width="700"></p>
<p>Indeed it seems the model works pretty well.</p>
<div class="section level3">
<h3 id="adding-rejection-sampling">Adding rejection sampling<a class="anchor" aria-label="anchor" href="#adding-rejection-sampling"></a>
</h3>
<p>As done previously, we could just exclude the fits that had
divergences, but just to complete our tour of possibilities, we’ll show
one more option to dealing with this type of problem.</p>
<p>The general idea is that although we might not want to/be able to
express our prior belief about the model (here that the two mixture
components are distinct) by priors on model parameters, we still may be
able to express our prior belief about the data itself.</p>
<p>And it turns out that if we remove simulations that don’t meet a
certain condition imposed on the observed data, the implied prior on
parameters becomes an additive constant and we can use exactly the same
model to fit only the non-rejected simulations. Note that this does not
hold if we rejected simulations based on some unobserved variables - for
more details see the <a href="https://hyunjimoon.github.io/SBC/articles/rejection_sampling.html"><code>rejection_sampling</code></a>
vignette.</p>
<p>The main advantage is that if we can do this, we can avoid wasting
computation on fitting data that would likely produce divergences
anyway. The downside is that it means we no longer have a guarantee the
model works for non-rejected data, so we need to check if the data we
want to analyze would not be rejected by our criterion.</p>
<p>How to build such a criterion here? We’ll note that for
Poisson-distributed variables the ratio of mean to variance (a.k.a the
Fano factor) is always 1. So if the components are too similar, the data
should resemble a Poisson distribution and have Fano factor of 1, while
if the components are distinct the Fano factor will be larger.</p>
<p>Below is a plot of fano factors versus the number of divergences
we’ve seen:</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fanos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">dataset_combined</span><span class="op">$</span><span class="va">generated</span>, </span>
<span>                <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span> <span class="fu">var</span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">}</span>, </span>
<span>                FUN.VALUE <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fanos</span>, <span class="va">results_combined</span><span class="op">$</span><span class="va">backend_diagnostics</span><span class="op">$</span><span class="va">n_divergent</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/combined_fanos-1.png" width="700"></p>
<p>All the divergence are for low fano factors - this is the histogram
of Fano factor for diverging fits:</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">fanos</span><span class="op">[</span><span class="va">results_combined</span><span class="op">$</span><span class="va">backend_diagnostics</span><span class="op">$</span><span class="va">n_divergent</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/fanos_divergent-1.png" width="700"></p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fano_threshold</span> <span class="op">&lt;-</span> <span class="fl">1.6</span></span></code></pre></div>
<p>So what we’ll do is that we’ll reject any simulation where the
observed data have Fano factor &lt; 1.6. In practice a simple way to
implement this is to wrap our generator code in a loop and break from
the loop only when the generated data meet our criteria (i.e. is not
rejected). This is our code:</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator_func_combined_reject</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N_obs</span>, <span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">N_obs</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Too low N_obs for this simulator"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">repeat</span> <span class="op">{</span></span>
<span>    <span class="co"># If the priors for all components of an ordered vector are the same</span></span>
<span>    <span class="co"># then just sorting the result of a generator is enough to create</span></span>
<span>    <span class="co"># a valid draw from the ordered vector prior</span></span>
<span>    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> </span>
<span>    </span>
<span>    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_predictors</span> <span class="op">*</span> <span class="va">N_obs</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">N_predictors</span>, ncol <span class="op">=</span> <span class="va">N_obs</span><span class="op">)</span></span>
<span>    <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># Intercept</span></span>
<span>  </span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="va">N_obs</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">linpred</span> <span class="op">&lt;-</span> <span class="va">linpred</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">p</span>, <span class="va">n</span><span class="op">]</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="va">p</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">linpred</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu">var</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">fano_threshold</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">break</span>;</span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>    </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="va">beta</span>,</span>
<span>      mu <span class="op">=</span> <span class="va">mu</span></span>
<span>    <span class="op">)</span>,</span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N_obs <span class="op">=</span> <span class="va">N_obs</span>,</span>
<span>      N_predictors <span class="op">=</span> <span class="va">N_predictors</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span>,</span>
<span>      x <span class="op">=</span> <span class="va">x</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator_combined_reject</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">generator_func_combined_reject</span>, N_obs <span class="op">=</span> <span class="fl">50</span>, N_predictors <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>We’ll once again fit our model to 200 simulations:</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">44685226</span><span class="op">)</span></span>
<span><span class="va">dataset_combined_reject</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_combined_reject</span>, <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_combined_reject</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">dataset_combined_reject</span>, <span class="va">backend_combined</span>, </span>
<span>                    keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"combined_reject"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'combined_reject'</span></span></code></pre>
<pre><code><span><span class="co">##  - 5 (2%) fits had some steps rejected. Maximum number of rejections was 2.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>No more divergences! And the ranks look nice.</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_combined_reject</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/combined_reject_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_combined_reject</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/combined_reject_plots-2.png" width="700"></p>
<p>And our coverage is pretty tight:</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_coverage.html">plot_coverage</a></span><span class="op">(</span><span class="va">results_combined_reject</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/combined_reject_coverage-1.png" width="700"></p>
<p>Below we show the uncertainty for two variables and some widths of
central posterior intervals numerically:</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats_subset</span> <span class="op">&lt;-</span> <span class="va">results_combined_reject</span><span class="op">$</span><span class="va">stats</span><span class="op">[</span></span>
<span>  <span class="va">results_combined_reject</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">variable</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta[1]"</span>, <span class="st">"mu[1]"</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="../reference/empirical_coverage.html">empirical_coverage</a></span><span class="op">(</span><span class="va">stats_subset</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>,<span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 8 × 6</span></span></span>
<span><span class="co">##   variable width width_represented ci_low estimate ci_high</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> beta[1]   0.25              0.25  0.159    0.21    0.272</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> beta[1]   0.5               0.5   0.392    0.46    0.529</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> beta[1]   0.9               0.9   0.828    0.88    0.918</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> beta[1]   0.95              0.95  0.904    0.945   0.969</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> mu[1]     0.25              0.25  0.168    0.22    0.283</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> mu[1]     0.5               0.5   0.397    0.465   0.534</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span> mu[1]     0.9               0.9   0.845    0.895   0.930</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">8</span> mu[1]     0.95              0.95  0.898    0.94    0.965</span></span></code></pre>
<p>Maybe we think the remaining uncertainty is too big, so we’ll run 300
more simulations, just to be sure:</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1395367854</span><span class="op">)</span></span>
<span><span class="va">dataset_combined_reject_more</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">generator_combined_reject</span>, <span class="fl">300</span><span class="op">)</span> </span>
<span><span class="va">results_combined_reject_more</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bind_results.html">bind_results</a></span><span class="op">(</span></span>
<span>  <span class="va">results_combined_reject</span>,</span>
<span>  <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">dataset_combined_reject_more</span>, <span class="va">backend_combined</span>, </span>
<span>                    keep_fits <span class="op">=</span> <span class="cn">FALSE</span>, cache_mode <span class="op">=</span> <span class="st">"results"</span>, </span>
<span>                    cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"combined_reject_more"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'combined_reject_more'</span></span></code></pre>
<pre><code><span><span class="co">##  - 3 (1%) fits had divergent transitions. Maximum number of divergences was 4.</span></span></code></pre>
<pre><code><span><span class="co">##  - 4 (1%) fits had some steps rejected. Maximum number of rejections was 2.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>We get some very small number of problematic fits, which we can
ignore in this volume (but probably more aggresive rejection sampling
would remove those as well).</p>
<p>Our plots and coverage are now pretty decent:</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_combined_reject_more</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_combined_reject_more_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_combined_reject_more</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_combined_reject_more_plots-2.png" width="700"></p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_coverage.html">plot_coverage</a></span><span class="op">(</span><span class="va">results_combined_reject_more</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/results_combined_reject_more_coverage-1.png" width="700"></p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats_subset</span> <span class="op">&lt;-</span> <span class="va">results_combined_reject_more</span><span class="op">$</span><span class="va">stats</span><span class="op">[</span></span>
<span>  <span class="va">results_combined_reject_more</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">variable</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta[1]"</span>, <span class="st">"mu[2]"</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="../reference/empirical_coverage.html">empirical_coverage</a></span><span class="op">(</span><span class="va">stats_subset</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>,<span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 8 × 6</span></span></span>
<span><span class="co">##   variable width width_represented ci_low estimate ci_high</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> beta[1]   0.25              0.25  0.171    0.204   0.242</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> beta[1]   0.5               0.5   0.437    0.48    0.524</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> beta[1]   0.9               0.9   0.864    0.894   0.918</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> beta[1]   0.95              0.95  0.925    0.948   0.964</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> mu[2]     0.25              0.25  0.242    0.28    0.321</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> mu[2]     0.5               0.5   0.522    0.566   0.609</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span> mu[2]     0.9               0.9   0.879    0.908   0.930</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">8</span> mu[2]     0.95              0.95  0.927    0.95    0.966</span></span></code></pre>
<p>This actually shows a limitation of the coverage results - for
<code>mu[2]</code> the approximate CI for coverage excludes exact
calibration for a bunch of intervals, but above we see that the more
trustworthy <code>plot_ecdf_diff</code> is not showing a problem
(although there is some tendency towards slight underdispersion).</p>
<p>Still, this might warrant further investigation if small
discrepancies in <code>mu</code> are considered important, if we are
interested only in the <code>beta</code> coefficients, we can stay
assured that their calibration is pretty good. We give you our word that
we ran additional simulations and the discrepancy disappears.</p>
<p>Finally, we can also use this simulation exercise to understand what
would we be likely to learn from an experiment matching the simulations
(50 observations, 3 predictors) and plot the true values (simulated by
the generator) against estimated mean + 90% posterior credible
interval:</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_sim_estimated.html">plot_sim_estimated</a></span><span class="op">(</span><span class="va">results_combined_reject_more</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="small_model_workflow_files/figure-html/sim_estimated_final-1.png" width="700"></p>
<p>We see that we get very precise information about <code>mu</code> and
a decent picture about all <code>beta</code> elements, but the reamining
uncertainty is large. We could for example compute the probability that
the posterior 90% interval for <code>beta[1]</code> excludes zero,
i.e. that we learn something about the sign of <code>beta[1]</code>:</p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats_beta1</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">results_combined_reject_more</span><span class="op">$</span><span class="va">stats</span><span class="op">[</span></span>
<span>    <span class="va">results_combined_reject_more</span><span class="op">$</span><span class="va">stats</span><span class="op">$</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"beta[1]"</span>,<span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign</a></span><span class="op">(</span><span class="va">stats_beta1</span><span class="op">$</span><span class="va">q5</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign</a></span><span class="op">(</span><span class="va">stats_beta1</span><span class="op">$</span><span class="va">q95</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.504</span></span></code></pre>
<p>Turns out the probability is only around 50%. Depending on your aims,
this might be a reason to plan for a larger sample size!</p>
</div>
</div>
<div class="section level2">
<h2 id="take-home-message">Take home message<a class="anchor" aria-label="anchor" href="#take-home-message"></a>
</h2>
<p>There are couple lessons I hope this exercise showed: First, building
models you can trust is hard work and it is very easy to make mistakes.
Despite the models presented here being relatively simple, diagnosing
the problems in them was not straightforward and required non-trivial
background knowledge. For this reason, moving in small steps during
model development is crucial and can save you time as diagnosing the
same problems in a 300-line Stan model with 50 parameters can be
basically impossible.</p>
<p>We also hope we convinced you that the SBC package lets you get
high-quality information from your simulation efforts and not only
diagnose problems but also get some sort of assurance in the end that
your model is at least pretty close to your simulator.</p>
<p>And that’s it for this vignette, thanks for staying until the end and
hope the workflow ideas will be useful for you!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Shinyoung Kim, Hyunji Moon, Martin Modrák, Teemu Säilynoja.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
