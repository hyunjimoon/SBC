<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discovering bad parametrization with SBC • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Discovering bad parametrization with SBC">
<meta property="og:description" content="SBC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bad_parametrization.html">Discovering bad parametrization with SBC</a>
    </li>
    <li>
      <a href="../articles/basic_usage.html">SBC Interface Introduction</a>
    </li>
    <li>
      <a href="../articles/brms.html">SBC for brms models</a>
    </li>
    <li>
      <a href="../articles/discrete_params.html">SBC with discrete parameters</a>
    </li>
    <li>
      <a href="../articles/indexing.html">Discovering indexing errors with SBC</a>
    </li>
    <li>
      <a href="../articles/limits_of_SBC.html">Limits of SBC</a>
    </li>
    <li>
      <a href="../articles/rejection_sampling.html">UNKNOWN TITLE</a>
    </li>
    <li>
      <a href="../articles/small_model_workflow.html">Small model workflow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="bad_parametrization_files/header-attrs-2.5/header-attrs.js"></script><link href="bad_parametrization_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="bad_parametrization_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Discovering bad parametrization with SBC</h1>
            
      
      
      <div class="hidden name"><code>bad_parametrization.Rmd</code></div>

    </div>

    
    
<p>Premise: we mistakenly assume that Stan does parametrize the normal distribution via mean and precision (like JAGS or INLA do). Since we want to put prior on the standard deviation (as is suggested on the prior choice wiki), we take standard deviation as the parameter and transform to precision <span class="math inline">\(\tau = \frac{1}{\sigma^2}\)</span>.</p>
<p>TODO maybe start with prior predictive check to tune priors?</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stan_code_1</span> <span class="op">&lt;-</span> <span class="st">"
data {
  int N;
  vector&lt;lower=0&gt;[N] y;
}

parameters {
  real&lt;lower = 0&gt; shape;
  real&lt;lower = 0&gt; scale;  
}

model {
  y ~ gamma(shape, scale);
  shape ~ lognormal(0, 1);
  scale ~ lognormal(0, 1.5);
}
"</span>
<span class="va">iter_warmup</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">iter_sampling</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">model_gamma</span> <span class="op">&lt;-</span> <span class="fu">cmdstan_model</span><span class="op">(</span><span class="fu">write_stan_file</span><span class="op">(</span><span class="va">stan_code_1</span><span class="op">)</span><span class="op">)</span>

  <span class="va">backend_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span>
    <span class="va">model_gamma</span>, iter_warmup <span class="op">=</span> <span class="va">iter_warmup</span>, iter_sampling <span class="op">=</span> <span class="va">iter_sampling</span>, chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">model_gamma</span> <span class="op">&lt;-</span> <span class="fu">stan_model</span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">stan_code_1</span><span class="op">)</span>

  <span class="va">backend_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span>
    <span class="va">model_gamma</span>, iter <span class="op">=</span> <span class="va">iter_sampling</span> <span class="op">+</span> <span class="va">iter_warmup</span>, warmup <span class="op">=</span> <span class="va">iter_warmup</span>, chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Build a generator to create simulated datasets.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">21448857</span><span class="op">)</span>
<span class="va">n_datasets</span> <span class="op">&lt;-</span> <span class="fl">10</span>

<span class="va">single_dataset_gamma</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, meanlog <span class="op">=</span>  <span class="fl">0</span>, sdlog <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, meanlog <span class="op">=</span> <span class="fl">0</span>, sdlog <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>
  
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="va">N</span>, shape <span class="op">=</span> <span class="va">shape</span>, scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      shape <span class="op">=</span> <span class="va">shape</span>,
      scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span>,
    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      N <span class="op">=</span> <span class="va">N</span>,
      y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>


<span class="va">generator_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">single_dataset_gamma</span>, N <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>
<span class="va">datasets_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span>
  <span class="va">generator_gamma</span>, 
  <span class="va">n_datasets</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_results.html">compute_results</a></span><span class="op">(</span><span class="va">datasets_gamma</span>, <span class="va">backend_gamma</span><span class="op">)</span></code></pre></div>
<pre><code>##  - 9 (90%) fits had some steps rejected. Maximum number of rejections was 6.</code></pre>
<pre><code>## Not all diagnostics are OK. You can learn more by inspecting $default_diagnostics, $backend_diagnostics and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</code></pre>
<p>10 simulations are enough to see something is wrong with the model. The problem is best seen on an <code>ecdf_diff</code> plot - we even see the issue is primarily with the <code>scale</code> parameter!</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_gamma</span><span class="op">)</span></code></pre></div>
<p><img src="bad_parametrization_files/figure-html/unnamed-chunk-4-1.png" width="700"> However, we can use the rank histogram (with suitable number of bins) and the <code>ecdf</code> plot to show different visualisations of the same problem. The rank histogram often tends to be intuitively more understandable than the <code>ecdf</code> plots, but tweaking the number of bins is often necessary and the confidence interval is only approximate and has decreased sensitivity.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_gamma</span>, bins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p><img src="bad_parametrization_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf</a></span><span class="op">(</span><span class="va">results_gamma</span><span class="op">)</span></code></pre></div>
<p><img src="bad_parametrization_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<p>So we see that the simulation does not match the model. In practice, the problem may lie with the simulation, with the model or both. Here, we’ll assume that the simulation is correct - we really wanted to work with scale and fix the model to match. I.e. we still represent scale in our model, but invert it to get rate before using Stan’s <code>gamma</code> distribution:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stan_code_2</span> <span class="op">&lt;-</span> <span class="st">"
data {
  int N;
  vector&lt;lower=0&gt;[N] y;
}

parameters {
  real&lt;lower = 0&gt; shape;
  real&lt;lower = 0&gt; scale;  
}

model {
  y ~ gamma(shape, inv(scale));
  shape ~ lognormal(0, 1);
  scale ~ lognormal(0, 1.5);
}
"</span>

<span class="kw">if</span><span class="op">(</span><span class="va">use_cmdstanr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">model_gamma_2</span> <span class="op">&lt;-</span> <span class="fu">cmdstan_model</span><span class="op">(</span><span class="fu">write_stan_file</span><span class="op">(</span><span class="va">stan_code_2</span><span class="op">)</span><span class="op">)</span>

  <span class="va">backend_gamma_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_cmdstan_sample.html">SBC_backend_cmdstan_sample</a></span><span class="op">(</span>
    <span class="va">model_gamma_2</span>, iter_warmup <span class="op">=</span> <span class="va">iter_warmup</span>, iter_sampling <span class="op">=</span> <span class="va">iter_sampling</span>, chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">model_gamma_2</span> <span class="op">&lt;-</span> <span class="fu">stan_model</span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">stan_code_2</span><span class="op">)</span>

  <span class="va">backend_gamma_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span>
    <span class="va">model_gamma_2</span>, iter <span class="op">=</span> <span class="va">iter_sampling</span> <span class="op">+</span> <span class="va">iter_warmup</span>, warmup <span class="op">=</span> <span class="va">iter_warmup</span>, chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_gamma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_results.html">compute_results</a></span><span class="op">(</span><span class="va">datasets_gamma</span>, <span class="va">backend_gamma_2</span><span class="op">)</span></code></pre></div>
<pre><code>##  - 2 (20%) fits had at least one Rhat &gt; 1.01. Largest Rhat was 1.011.</code></pre>
<pre><code>##  - 10 (100%) fits had some steps rejected. Maximum number of rejections was 6.</code></pre>
<pre><code>## Not all diagnostics are OK. You can learn more by inspecting $default_diagnostics, $backend_diagnostics and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</code></pre>
<p>No obvious problems here, but if we wanted to be sure, we should have ran a lot more simulations.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_gamma2</span><span class="op">)</span></code></pre></div>
<p><img src="bad_parametrization_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_gamma2</span>, bins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p><img src="bad_parametrization_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_ecdf.html">plot_ecdf</a></span><span class="op">(</span><span class="va">results_gamma2</span><span class="op">)</span></code></pre></div>
<p><img src="bad_parametrization_files/figure-html/unnamed-chunk-8-3.png" width="700"></p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Shinyoung Kim, Hyunji Moon, Martin Modrák.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
