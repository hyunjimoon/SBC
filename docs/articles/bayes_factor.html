<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBC for Bayes factors (with rstan and bridgesampling) • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SBC for Bayes factors (with rstan and bridgesampling)">
<meta property="og:description" content="SBC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="hyunjimoon.github.io" src="https://plausible.io/js/script.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SBC.html">Get Started</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="http://paul-buerkner.github.io/brms/" class="external-link">brms</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior" class="external-link">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/hyunjimoon/SBC" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SBC for Bayes factors (with rstan and
bridgesampling)</h1>
                        <h4 data-toc-skip class="author">Martin
Modrák</h4>
            
            <h4 data-toc-skip class="date">2025-09-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hyunjimoon/SBC/blob/HEAD/vignettes/bayes_factor.Rmd" class="external-link"><code>vignettes/bayes_factor.Rmd</code></a></small>
      <div class="hidden name"><code>bayes_factor.Rmd</code></div>

    </div>

    
    
<p>SBC can be used to verify Bayes factor computation. The key is to
realize, that whenever we compute a Bayes factor between two models
<span class="math inline">\(\mathcal{M}_0, \mathcal{M}_1\)</span>, with
the associated prior <span class="math inline">\(\pi^0_\text{prior},
\pi^1_\text{prior}\)</span> and observational distributions <span class="math inline">\(\pi^0_\text{obs}, \pi^1_\text{obs}\)</span>, it is
the same as making an inference over a larger model of the form:</p>
<p><span class="math display">\[
\begin{aligned}
i &amp;\sim \text{Bernoulli}(\text{Pr}(\mathcal{M}_1))\\
\theta_i &amp;\sim \pi^i_\text{prior} \\
y &amp;\sim \pi_\text{obs}^i(\theta_i)
\end{aligned}
\]</span></p>
<p>The same model is also implied whenever we do Bayesian model
averaging (BMA). The Bayes factor is fully determined by the posterior
distribution of the model index <span class="math inline">\(i\)</span>
in this larger model:</p>
<p><span class="math display">\[
\frac{\text{Pr}(\mathcal{M}_i \mid y)}{\text{Pr}(\mathcal{M}_j \mid y)}
=
BF_{i,j}\frac{\text{Pr}(\mathcal{M}_i)}{\text{Pr}(\mathcal{M}_j)}
\]</span></p>
<p>This means, we can run SBC for this larger model! The results also
naturally generalize to multiple models.</p>
<p>Additionally, we may also employ diagnostics specific for binary
variables, like testing if the predictions are <em>calibrated</em>,
e.g. that whenever posterior probability of model 1 is 75%, we expect
the model 1 to generate the data in about 75% of the cases. We may also
test the data-averaged posterior, i.e. that the average posterior model
probability is equal to the prior model probability.</p>
<div class="section level2">
<h2 id="setting-up">Setting up<a class="anchor" aria-label="anchor" href="#setting-up"></a>
</h2>
<p>Let’s setup the environment (<code>bridgesampling</code> currently
works only with <code>rstan</code>, so we cannot use
<code>cmdstanr</code> as we do in other vignettes):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hyunjimoon.github.io/SBC/">SBC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/quentingronau/bridgesampling" class="external-link">bridgesampling</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rstan/man/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="st">"./_bayes_factor_rstan_SBC_cache"</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fit_cache_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"fits"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">fit_cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">fit_cache_dir</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run this _in the console_ to report progress for all computations to report progress for all computations</span></span>
<span><span class="co"># see https://progressr.futureverse.org/ for more options</span></span>
<span><span class="fu">progressr</span><span class="fu">::</span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span>global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We will use a model very similar to the <code>turtles</code> example
from the <code>bridgesampling</code> package — a test of presence of a
random effect in a binomial probit model. Specifically, under <span class="math inline">\(H_1\)</span></p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim  \text{Bernoulli}(\Phi(\alpha + \beta x_{i} +
\gamma_{g_i})),  &amp;i = 1,2,\ldots,N\\
\gamma_j &amp;\sim N(0, \sigma),  &amp;j = 1,2,\ldots, G \\
\alpha &amp;\sim N(0, \sqrt{10}),\\
\beta &amp;\sim N(0, \sqrt{10}),\\
\sigma &amp;\sim \text{Half}N(0, 1)
\end{aligned}
\]</span></p>
<p>and under <span class="math inline">\(H_0\)</span> we assume that
there is no random effect, i.e. that <span class="math inline">\(\tau =
0\)</span>.</p>
</div>
<div class="section level2">
<h2 id="incorrect-model-and-bf">Incorrect model and BF<a class="anchor" aria-label="anchor" href="#incorrect-model-and-bf"></a>
</h2>
<p>Here is a naive implementation of the model under <span class="math inline">\(H_0\)</span>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"stan/turtles_H0.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower = 1&gt; N;
  array[N] int&lt;lower = 0, upper = 1&gt; y;
  vector[N] x;
}

parameters {
  real alpha0_raw;
  real alpha1_raw;
}

transformed parameters {
  real alpha0 = sqrt(10) * alpha0_raw;
  real alpha1 = sqrt(10) * alpha1_raw;
}

model {
  // priors
  target += normal_lpdf(alpha0_raw | 0, 1);
  target += normal_lpdf(alpha1_raw | 0, 1);

  // likelihood
  for (i in 1:N) {
    target += bernoulli_lpmf(y[i] | Phi(alpha0 + alpha1 * x[i]));
  }
}</code></pre>
<p>and under H1:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"stan/turtles_H1_bad_normalization.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower = 1&gt; N;
  array[N] int&lt;lower = 0, upper = 1&gt; y;
  vector[N] x;
  int&lt;lower = 1&gt; C;
  array[N] int&lt;lower = 1, upper = C&gt; clutch;
}

parameters {
  real alpha0_raw;
  real alpha1_raw;
  vector[C] b_raw;
  real&lt;lower = 0&gt; sigma;
}

transformed parameters {
  vector[C] b;
  real alpha0 = sqrt(10) * alpha0_raw;
  real alpha1 = sqrt(10) * alpha1_raw;
  b = sigma * b_raw;
}

model {
  // priors
  target += normal_lpdf(sigma | 0, 1);

  target += normal_lpdf(alpha0_raw | 0, 1);
  target += normal_lpdf(alpha1_raw | 0, 1);

  // random effects
  target += normal_lpdf(b_raw | 0, 1);

  // likelihood
  for (i in 1:N) {
    target += bernoulli_lpmf(y[i] | Phi(alpha0 + alpha1 * x[i] + b[clutch[i]]));
  }
}</code></pre>
<p>as the name of the file suggests, the implementation is in fact
wrong. We will let you guess what’s wrong and see if we can uncover this
with SBC and discuss the problem later.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m_H0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"stan/turtles_H0.stan"</span><span class="op">)</span></span>
<span><span class="va">m_H1_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"stan/turtles_H1_bad_normalization.stan"</span><span class="op">)</span></span></code></pre></div>
<p>The simplest we can do is to actually write simulator that can
simulate the data and parameters under each hypothesis separately,
instead of directly simulating the BMA supermodel as it will let the
<code>SBC</code> package do some useful stuff for us.</p>
<p>We will also reject low variability datasets - see
<code><a href="../articles/rejection_sampling.html">vignette("rejection_sampling")</a></code> for background. To gain
maximum sensitivity, our simulator also implements the log-likelihood
(<code>lp__</code>) as a derived test quantity, including all Jacobian
adjustments.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"turtles"</span>, package <span class="op">=</span> <span class="st">"bridgesampling"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_turtles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">N</span>, <span class="va">C</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">N</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">C</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Rejection sampling to avoid low-variability datasets</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">200</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">alpha0_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> </span>
<span>    <span class="va">alpha1_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> </span>
<span>    <span class="va">alpha0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="va">alpha0_raw</span></span>
<span>    <span class="va">alpha1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="va">alpha1_raw</span></span>
<span>    </span>
<span>    <span class="va">clutch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">C</span>, length.out <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>  </span>
<span>    </span>
<span>    <span class="va">log_lik_shared</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">alpha0_raw</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">alpha1_raw</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">predictor</span> <span class="op">&lt;-</span> <span class="va">alpha0</span> <span class="op">+</span> <span class="va">alpha1</span> <span class="op">*</span> <span class="va">x</span></span>
<span>      <span class="va">log_lik_spec</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">sigma_clutch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">b_clutch_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span></span>
<span>      <span class="va">b_clutch</span> <span class="op">&lt;-</span> <span class="va">b_clutch_raw</span> <span class="op">*</span> <span class="va">sigma_clutch</span></span>
<span>      </span>
<span>      <span class="va">predictor</span> <span class="op">&lt;-</span> <span class="va">alpha0</span> <span class="op">+</span> <span class="va">alpha1</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="va">b_clutch</span><span class="op">[</span><span class="va">clutch</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="va">log_lik_spec</span> <span class="op">&lt;-</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sigma_clutch</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">sigma_clutch</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">b_clutch_raw</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">predictor</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, p <span class="op">=</span> <span class="va">prob</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.9</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">break</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">&gt;=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Could not generate nice dataset"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">log_lik_predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">y</span>, size <span class="op">=</span> <span class="fl">1</span>, p <span class="op">=</span> <span class="va">prob</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      alpha0 <span class="op">=</span> <span class="va">alpha0</span>,</span>
<span>      alpha1 <span class="op">=</span> <span class="va">alpha1</span>,</span>
<span>      lp__ <span class="op">=</span> <span class="va">log_lik_shared</span> <span class="op">+</span> <span class="va">log_lik_spec</span> <span class="op">+</span> <span class="va">log_lik_predictor</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">sigma_clutch</span></span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">b_clutch</span></span>
<span>  <span class="op">}</span> </span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    generated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="va">N</span>,</span>
<span>      y <span class="op">=</span> <span class="va">y</span>,</span>
<span>      x <span class="op">=</span> <span class="va">x</span>,</span>
<span>      C <span class="op">=</span> <span class="va">C</span>,</span>
<span>      clutch <span class="op">=</span> <span class="va">clutch</span></span>
<span>    <span class="op">)</span>,</span>
<span>    variables <span class="op">=</span> <span class="va">variables</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We now generate some datasets for each model separately and then use
<code>SBC_datasets_for_bf</code> to build a combined dataset sampling
the true model randomly, but that also keeps track of all the shared
(and not shared) parameters:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54223248</span><span class="op">)</span></span>
<span><span class="va">N_sims</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">72</span></span>
<span><span class="va">C</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">ds_turtles_m0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">sim_turtles</span>, model <span class="op">=</span> <span class="fl">0</span>, N <span class="op">=</span> <span class="va">N</span>, C <span class="op">=</span> <span class="va">C</span><span class="op">)</span>, n_sims <span class="op">=</span> <span class="va">N_sims</span><span class="op">)</span></span>
<span><span class="va">ds_turtles_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="fu"><a href="../reference/SBC_generator_function.html">SBC_generator_function</a></span><span class="op">(</span><span class="va">sim_turtles</span>, model <span class="op">=</span> <span class="fl">1</span>, N <span class="op">=</span> <span class="va">N</span>, C <span class="op">=</span> <span class="va">C</span><span class="op">)</span>, n_sims <span class="op">=</span> <span class="va">N_sims</span><span class="op">)</span></span>
<span><span class="va">ds_turtles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_datasets_for_bf.html">SBC_datasets_for_bf</a></span><span class="op">(</span><span class="va">ds_turtles_m0</span>, <span class="va">ds_turtles_m1</span><span class="op">)</span></span></code></pre></div>
<p>Let us now build a <code>bridgesampling</code> backend — this will
take backends based on the individual models as arguments. The backend
in question need to implement the
<code><a href="../reference/SBC_fit_to_bridge_sampler.html">SBC_fit_to_bridge_sampler()</a></code> S3 method. Out of the box, this
is supported by <code><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample()</a></code> and
<code><a href="../reference/SBC_backend_brms.html">SBC_backend_brms()</a></code>. Note that we keep a pretty high number
of iterations as <code>bridgesampling</code> needs that (the specific
numbers are taken straight from <code>bridgesampling</code>
documentation).</p>
<p>One more trick we showcase is that we can cache individual model
fits, if we wrap a backend with <code><a href="../reference/SBC_backend_cached.html">SBC_backend_cached()</a></code>. Since
we will reuse the same H0 model later, we will do this here just for the
H0 model. Obviously everything will also work without caching. For H1,
some datasets cause divergences, and we are lazy to fully fix that
issue, so we instead increase <code>adapt_delta</code> and
<code>max_treedepth</code> (effectively avoiding the problem by using
more compute).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iter</span> <span class="op">&lt;-</span> <span class="fl">15500</span></span>
<span><span class="va">warmup</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">backend_turtles_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_bridgesampling.html">SBC_backend_bridgesampling</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/SBC_backend_cached.html">SBC_backend_cached</a></span><span class="op">(</span></span>
<span>    <span class="va">fit_cache_dir</span>,</span>
<span>    <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">m_H0</span>, iter <span class="op">=</span> <span class="va">iter</span>, warmup <span class="op">=</span> <span class="va">warmup</span>, init <span class="op">=</span> <span class="va">init</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">m_H1_bad</span>, iter <span class="op">=</span> <span class="va">iter</span>, warmup <span class="op">=</span> <span class="va">warmup</span>, init <span class="op">=</span> <span class="va">init</span>,</span>
<span>                           control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span>, max_treedepth <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_turtles_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">ds_turtles</span>, <span class="va">backend_turtles_bad</span>, </span>
<span>                           keep_fits <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                           cache_mode <span class="op">=</span> <span class="st">"results"</span>,</span>
<span>                           cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"turtles_bad.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'turtles_bad.rds'</span></span></code></pre>
<pre><code><span><span class="co">##  - 6 (3%) fits gave warning. Inspect $warnings for the full messages.</span></span></code></pre>
<pre><code><span><span class="co">##  - H1: 6 (3%) fits had divergences. Maximum number of divergences was 3.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>We have a small number of fits with small number of divergences,
which we will ignore for now.</p>
<p>Lets look at the default SBC diagnostics. Note that the plot by
default combines all parameters that are present in at least a single
model. It then uses the implied BMA supermodel to get draws of the
parameters (when a parameter is not present in the model, all its draws
are assumed to be <code>-Inf</code>). This means that any SBC
diagnostics for model parameters combines the correctness of the model
index (and hence Bayes factor) with the correctness of the individual
model posteriors.</p>
<p>For clarity, we combine all the random effects in a single panel:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">res_turtles_bad</span>, combine_variables <span class="op">=</span> <span class="va">combine_array_elements</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayes_factor_files/figure-html/ecdf-bad-1.png" width="700"></p>
<p>OK, this is not great, but not completely conclusive — given the
number of variables, some ECDFs being borderline outside the expected
range is possible even when the model works as expected. If we had no
better tools, it would make sense to run more simulations at this point.
But we do have better tools.</p>
<p>How about binary prediction calibration? Let’s look at calibration
plot (the default type relies on
<code><a href="https://rdrr.io/pkg/reliabilitydiag/man/reliabilitydiag.html" class="external-link">reliabilitydiag::reliabilitydiag()</a></code> and especially with
smaller number of simulations, using
<code>region.method = "resampling"</code> is more reliable than the
default approximation for the uncertainty region). The histogram at the
bottom shows the distribution of observed posterior model
probabilities.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/binary_calibration.html">plot_binary_calibration</a></span><span class="op">(</span><span class="va">res_turtles_bad</span>, region.method <span class="op">=</span> <span class="st">"resampling"</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayes_factor_files/figure-html/calib-bad-1.png" width="700"></p>
<p>That is very clearly bad (the observed calibration is the black line,
while the blue area is a confidence region assuming the probabilities
are calibrated, we get miscalibration in multiple regions). We may also
run a formal miscalibration test — we first extract the binary
probabilities and then pass them to the test:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bp_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binary_probabilities_from_stats.html">binary_probabilities_from_stats</a></span><span class="op">(</span><span class="va">res_turtles_bad</span><span class="op">$</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/binary-calibration-tests.html">miscalibration_resampling_test</a></span><span class="op">(</span><span class="va">bp_bad</span><span class="op">$</span><span class="va">prob</span>, <span class="va">bp_bad</span><span class="op">$</span><span class="va">simulated_value</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Bootstrapped binary miscalibration test (using 10000 samples)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  x = bp_bad$prob, y = bp_bad$simulated_value</span></span>
<span><span class="co">## 95% rejection limit = 0.018184, p-value = 1e-04</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">## miscalibration </span></span>
<span><span class="co">##     0.03427163</span></span></code></pre>
<p>Even more bad. A lesson here is that the formal test is often a bit
more sensitive than the test implied by the calibration plot — in
effect, the plot will show specific model probabilities where the
predictions are miscalibrated, while the test looks at miscalibration as
a global phenomenon, so it can integrate weak signals at different model
probabilities. We also implement miscalibration test based on Brier
score, which is typically somewhat less sensitive, but included here for
completeness:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/binary-calibration-tests.html">brier_resampling_test</a></span><span class="op">(</span><span class="va">bp_bad</span><span class="op">$</span><span class="va">prob</span>, <span class="va">bp_bad</span><span class="op">$</span><span class="va">simulated_value</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Bootstrapped binary Brier score test (using 10000 samples)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  x = bp_bad$prob, y = bp_bad$simulated_value</span></span>
<span><span class="co">## 95% rejection limit = 32.975, p-value = 0.0162</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">## Brier score </span></span>
<span><span class="co">##     34.5696</span></span></code></pre>
<p>Finally, we may also look at the data-averaged posterior. If we
believe we made enough simulations for the central limit theorem to kick
in, the highest sensitivity is achieved by one sample t-test (we
simulated with prior model probability = 0.5):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span><span class="va">bp_bad</span><span class="op">$</span><span class="va">prob</span>, mu <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  One Sample t-test</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  bp_bad$prob</span></span>
<span><span class="co">## t = -4.2063, df = 199, p-value = 3.925e-05</span></span>
<span><span class="co">## alternative hypothesis: true mean is not equal to 0.5</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.3613234 0.4498488</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">## mean of x </span></span>
<span><span class="co">## 0.4055861</span></span></code></pre>
<p>Also very bad. In the cases where we are not sure the CLT holds
(small number of simulations + “ugly” distribution of posterior model
probabilities), we may also run the Gaffke test, which makes no
assumptions about the distribution of posterior model probabilities
beyond them being bounded between 0 and 1:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gaffke_test.html">gaffke_test</a></span><span class="op">(</span><span class="va">bp_bad</span><span class="op">$</span><span class="va">prob</span>, mu <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Gaffke's test for the mean of a bounded variable (using 10000 samples)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  bp_bad$prob</span></span>
<span><span class="co">## lower bound = 0, upper bound = 1, p-value = 2e-04</span></span>
<span><span class="co">## alternative hypothesis: true mean is not equal to 0.5</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.3612327 0.4528509</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##      mean </span></span>
<span><span class="co">## 0.4055861</span></span></code></pre>
<p>the Gaffke test has somewhat lower power (since it makes fewer
assumptions), but the results are also very bad.</p>
<p>At this point, it would be tempting to blame the
<code>bridgesampling</code> package, but we cannot be sure. It is
possible, that the problem is that one of the models produces incorrect
posterior.</p>
<p>An advantage of using <code>SBC_datasets_for_bf</code> to generate
the datasets, is that we can use the same simulations to also do SBC for
individual models (this and other special handling is achieved
internally via setting <code><a href="../reference/variable-attributes.html">var_attributes()</a></code>):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats_split_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/split_SBC_results_for_bf.html">split_SBC_results_for_bf</a></span><span class="op">(</span><span class="va">res_turtles_bad</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">stats_split_bad</span><span class="op">$</span><span class="va">stats_H0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"M0"</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayes_factor_files/figure-html/ecdf-bad-split-1.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">stats_split_bad</span><span class="op">$</span><span class="va">stats_H1</span>, </span>
<span>               combine_variables <span class="op">=</span> <span class="va">combine_array_elements</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"M1"</span><span class="op">)</span>  </span></code></pre></div>
<p><img src="bayes_factor_files/figure-html/ecdf-bad-split-2.png" width="700"></p>
<p>Those don’t look bad (though we don’t have a ton of simulation for
each to be sure).</p>
<p>We’ll now reveal the problem (if you haven’t already noticed). For
normal posterior sampling, Stan only needs the model to implement the
density up to a constant factor. However, for
<code>bridgesampling</code>, we need all of those constants included to
obtain a correct estimate of the marginal likelihood. In the H1 model,
when we have <code>target += normal_lpdf(sigma | 0, 1);</code> we are
ignoring a factor of two as <code>sigma</code> has a half-normal
distribution.</p>
<p>In situations like this, when the Bayes factor computation is biased,
data-averaged posterior tends to be the most sensitive check. However,
for other problems in Bayes factor computation, like incorrect variance
or more subtle issues, testing binary prediction calibration tends to be
the most sensitive. Default SBC is less sensitive in the sense that it
typically requires more simulations to signal a problem than binary
prediction calibration checks, but more sensitive in the sense that some
problems won’t manifest with data-averaged posterior or binary
prediction calibration, but will (with enough simulation and good test
quantities) be detected by SBC.</p>
<p><a href="https://doi.org/10.1007/s00407-022-00298-3" class="external-link">Tsukamura and
Okada (2024)</a> have noted that many published Stan models do not
include proper normalization for bounded parameters and all of those
models could thus produce incorrect Bayes factors if used with
<code>bridgesampling</code>, so this is a computational problem one can
expect to actually see in the wild.</p>
</div>
<div class="section level2">
<h2 id="correct-model">Correct model<a class="anchor" aria-label="anchor" href="#correct-model"></a>
</h2>
<p>With the normalization constant included the correct H1 model is:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"stan/turtles_H1.stan"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code>data {
  int&lt;lower = 1&gt; N;
  array[N] int&lt;lower = 0, upper = 1&gt; y;
  vector[N] x;
  int&lt;lower = 1&gt; C;
  array[N] int&lt;lower = 1, upper = C&gt; clutch;
}

parameters {
  real alpha0_raw;
  real alpha1_raw;
  vector[C] b_raw;
  real&lt;lower = 0&gt; sigma;
}

transformed parameters {
  vector[C] b;
  real alpha0 = sqrt(10) * alpha0_raw;
  real alpha1 = sqrt(10) * alpha1_raw;
  b = sigma * b_raw;
}

model {
  // priors
  target += -normal_lccdf(0 | 0, 1); //norm. constant for the sigma prior
  target += normal_lpdf(sigma | 0, 1);

  target += normal_lpdf(alpha0_raw | 0, 1);
  target += normal_lpdf(alpha1_raw | 0, 1);

  // random effects
  target += normal_lpdf(b_raw | 0, 1);

  // likelihood
  for (i in 1:N) {
    target += bernoulli_lpmf(y[i] | Phi(alpha0 + alpha1 * x[i] + b[clutch[i]]));
  }
}</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m_H1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"stan/turtles_H1.stan"</span><span class="op">)</span></span></code></pre></div>
<p>Now lets run SBC with the correct model:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">backend_turtles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SBC_backend_bridgesampling.html">SBC_backend_bridgesampling</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/SBC_backend_cached.html">SBC_backend_cached</a></span><span class="op">(</span></span>
<span>    <span class="va">fit_cache_dir</span>,</span>
<span>    <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">m_H0</span>, iter <span class="op">=</span> <span class="va">iter</span>, warmup <span class="op">=</span> <span class="va">warmup</span>, init <span class="op">=</span> <span class="va">init</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/SBC_backend_rstan_sample.html">SBC_backend_rstan_sample</a></span><span class="op">(</span><span class="va">m_H1</span>, iter <span class="op">=</span> <span class="va">iter</span>, warmup <span class="op">=</span> <span class="va">warmup</span>, init <span class="op">=</span> <span class="va">init</span>, </span>
<span>                           control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span>, max_treedepth <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_turtles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">ds_turtles</span>, <span class="va">backend_turtles</span>, </span>
<span>                           keep_fits <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                           cache_mode <span class="op">=</span> <span class="st">"results"</span>,</span>
<span>                           cache_location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cache_dir</span>, <span class="st">"turtles.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Results loaded from cache file 'turtles.rds'</span></span></code></pre>
<pre><code><span><span class="co">##  - 7 (4%) fits gave warning. Inspect $warnings for the full messages.</span></span></code></pre>
<pre><code><span><span class="co">##  - H1: 7 (4%) fits had divergences. Maximum number of divergences was 2.</span></span></code></pre>
<pre><code><span><span class="co">## Not all diagnostics are OK.</span></span>
<span><span class="co">## You can learn more by inspecting $default_diagnostics, $backend_diagnostics </span></span>
<span><span class="co">## and/or investigating $outputs/$messages/$warnings for detailed output from the backend.</span></span></code></pre>
<p>we got a small number of divergences, which we will ignore here</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">res_turtles</span>, combine_variables <span class="op">=</span> <span class="va">combine_array_elements</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayes_factor_files/figure-html/ecdf-ok-1.png" width="700"></p>
<p>Wee see no big problems (although <code>sigma</code> is borderline,
we would expect this to disappear with more simulations, as we are quite
sure the model is in fact correct and <code>bridgesampling</code> works
for this problem)</p>
<p>Similarly, binary prediction calibration also looks almost good</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/binary_calibration.html">plot_binary_calibration</a></span><span class="op">(</span><span class="va">res_turtles</span>, region.method <span class="op">=</span> <span class="st">"resampling"</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayes_factor_files/figure-html/calib-ok-1.png" width="700"></p>
<p>Formal miscalibration test shows no problems:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binary_probabilities_from_stats.html">binary_probabilities_from_stats</a></span><span class="op">(</span><span class="va">res_turtles</span><span class="op">$</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/binary-calibration-tests.html">miscalibration_resampling_test</a></span><span class="op">(</span><span class="va">bp</span><span class="op">$</span><span class="va">prob</span>, <span class="va">bp</span><span class="op">$</span><span class="va">simulated_value</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Bootstrapped binary miscalibration test (using 10000 samples)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  x = bp$prob, y = bp$simulated_value</span></span>
<span><span class="co">## 95% rejection limit = 0.019416, p-value = 0.2275</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">## miscalibration </span></span>
<span><span class="co">##     0.01579185</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/binary-calibration-tests.html">brier_resampling_test</a></span><span class="op">(</span><span class="va">bp</span><span class="op">$</span><span class="va">prob</span>, <span class="va">bp</span><span class="op">$</span><span class="va">simulated_value</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Bootstrapped binary Brier score test (using 10000 samples)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  x = bp$prob, y = bp$simulated_value</span></span>
<span><span class="co">## 95% rejection limit = 37.805, p-value = 0.8908</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">## Brier score </span></span>
<span><span class="co">##    30.93992</span></span></code></pre>
<p>And that data-averaged posterior? Both with t-test and the Gaffke
test we see no problems and resonably tight confidence intervals
centered at the expected value of 0.5.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span><span class="va">bp</span><span class="op">$</span><span class="va">prob</span>, mu <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  One Sample t-test</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  bp$prob</span></span>
<span><span class="co">## t = 0.6904, df = 199, p-value = 0.4907</span></span>
<span><span class="co">## alternative hypothesis: true mean is not equal to 0.5</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.4742132 0.5535705</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">## mean of x </span></span>
<span><span class="co">## 0.5138919</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gaffke_test.html">gaffke_test</a></span><span class="op">(</span><span class="va">bp</span><span class="op">$</span><span class="va">prob</span>, mu <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Gaffke's test for the mean of a bounded variable (using 10000 samples)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  bp$prob</span></span>
<span><span class="co">## lower bound = 0, upper bound = 1, p-value = 0.5748</span></span>
<span><span class="co">## alternative hypothesis: true mean is not equal to 0.5</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.4737775 0.5557198</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##      mean </span></span>
<span><span class="co">## 0.5138919</span></span></code></pre>
<p>So no problems here, up to the resolution available with 200
simulations. In practice, we would recommend running more simulations
for thorough checks, but this is just an example that should compute in
reasonable time.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Modrák, Shinyoung Kim, Angie.H Moon, Teemu Säilynoja.</p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>This site uses <a href="https://plausible.io" class="external-link">Plausible.io</a> for privacy-friendly web analytics (no cookies, no tracking).</p>
<p>Our stats are public at: <a href="https://plausible.io/hyunjimoon.github.io" class="external-link uri">https://plausible.io/hyunjimoon.github.io</a></p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
