<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulation Based Calibration for rstan/cmdstanr models • SBC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Simulation Based Calibration for rstan/cmdstanr models">
<meta property="og:description" content="SBC helps perform Simulation Based Calibration on Bayesian models. 
    SBC lets you check for bugs in your model code and/or algorithm that fits 
    the model. SBC focuses on models built with Stan &lt;https://mc-stan.org&gt;,
    but can support other modelling languages as well.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="hyunjimoon.github.io" src="https://plausible.io/js/script.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">SBC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="articles/SBC.html">Get Started</a>
</li>
<li>
  <a href="articles/index.html">Vignettes</a>
</li>
<li>
  <a href="reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="http://paul-buerkner.github.io/brms/" class="external-link">brms</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior" class="external-link">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/hyunjimoon/SBC" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="simulation-based-calibration-sbc">Simulation-based Calibration: SBC<a class="anchor" aria-label="anchor" href="#simulation-based-calibration-sbc"></a>
</h1></div>
<p>SBC provides tools to validate your Bayesian model and/or a sampling algorithm via the self-recovering property of Bayesian models. This package lets you run SBC easily and perform postprocessing and visualisations of the results to assess computational faithfulness.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To install the development version of SBC, run</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"hyunjimoon/SBC"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="quick-tour">Quick tour<a class="anchor" aria-label="anchor" href="#quick-tour"></a>
</h2>
<p>To use SBC, you need a piece of code that generates simulated data that should match your model (a <em>generator</em>) and a statistical model + algorithm + algorithm parameters that can fit the model to data (a <em>backend</em>). SBC then lets you discover when the backend and generator don’t encode the same data generating process (up to <a href="https://hyunjimoon.github.io/SBC/articles/limits_of_SBC.html">certain limitations</a>).</p>
<p>For a quick example, we’ll use a simple generator producing normally-distributed data (basically <code>y &lt;- rnorm(N, mu, sigma)</code>) with a backend in Stan that mismatches the generator by wrongly assuming Stan parametrizes the normal distribution via precision (i.e. it has <code>y ~ normal(mu, 1 / sigma ^ 2)</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hyunjimoon.github.io/SBC/">SBC</a></span><span class="op">)</span></span>
<span><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/SBC_example_generator.html">SBC_example_generator</a></span><span class="op">(</span><span class="st">"normal"</span><span class="op">)</span></span>
<span><span class="co"># interface = "cmdstanr" or "rjags" is also supported</span></span>
<span><span class="va">backend_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/SBC_example_backend.html">SBC_example_backend</a></span><span class="op">(</span><span class="st">"normal_bad"</span>, interface <span class="op">=</span> <span class="st">"rstan"</span><span class="op">)</span></span></code></pre></div>
<p><em>Note: Using the <code>cmdstanr</code> interface, a small number of rejected steps will be reported. Those are false positives and do not threaten validity (they happen during warmup). This is a result of difficulties in parsing the output of <code>cmdstanr</code>. We are working on a resolution.</em></p>
<p>You can use <code>SBC_print_example_model("normal_bad")</code> to inspect the model used.</p>
<p>We generate 50 simulated datasets and perform SBC:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generate_datasets.html">generate_datasets</a></span><span class="op">(</span><span class="va">gen</span>, n_sims <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">results_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">ds</span>, <span class="va">backend_bad</span><span class="op">)</span></span></code></pre></div>
<p>The results then give us diagnostic plots that immediately show a problem: the distribution of SBC ranks is not uniform as witnessed by both the rank histogram and the difference between sample ECDF and the expected deviations from theoretical CDF.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_bad</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_bad</span><span class="op">)</span></span></code></pre></div>
<p>We can then run SBC with a backend that uses the correct parametrization (i.e. with <code>y ~ normal(mu, sigma)</code>):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">backend_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/SBC_example_backend.html">SBC_example_backend</a></span><span class="op">(</span><span class="st">"normal_sd"</span>, interface <span class="op">=</span> <span class="st">"rstan"</span><span class="op">)</span></span>
<span><span class="va">results_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compute_SBC.html">compute_SBC</a></span><span class="op">(</span><span class="va">ds</span>, <span class="va">backend_sd</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/plot_rank_hist.html">plot_rank_hist</a></span><span class="op">(</span><span class="va">results_sd</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ECDF-plots.html">plot_ecdf_diff</a></span><span class="op">(</span><span class="va">results_sd</span><span class="op">)</span></span></code></pre></div>
<p>The diagnostic plots show no problems in this case. As with any other software test, we can observe clear failures, but absence of failures does not imply correctness. We can however make the SBC check more thorough by using a lot of simulations and including suitable derived quantities to guard against <a href="https://hyunjimoon.github.io/SBC/articles/limits_of_SBC.html">known limitations of vanilla SBC</a>.</p>
</div>
<div class="section level2">
<h2 id="paralellization">Paralellization<a class="anchor" aria-label="anchor" href="#paralellization"></a>
</h2>
<p>The examples above are very fast to compute, but in real use cases, you almost certainly want to let the computation run in parallel via the <a href="https://future.futureverse.org/" class="external-link"><code>future</code></a> package.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="more-information">More information<a class="anchor" aria-label="anchor" href="#more-information"></a>
</h2>
<p>The <a href="https://hyunjimoon.github.io/SBC/articles/">package vignettes</a> provide additional context and examples. Notably:</p>
<ul>
<li>
<a href="https://hyunjimoon.github.io/SBC/articles/SBC.html">The main vignette</a> has more theoretical background and instructions how to integrate your own simulation code and models with SBC.</li>
<li>
<a href="https://hyunjimoon.github.io/SBC/articles/small_model_workflow.html">Small model workflow</a> discusses how SBC integrates with model implementation workflow and how you can use SBC to safely develop complex models step-by-step.</li>
</ul>
<p>Currently <code>SBC</code> supports <code>cmdstanr</code>, <code>rstan</code>, and <code>brms</code> models out of the box. With a little additional work, you can integrate SBC with any exact or approximate fitting method as shown in the <a href="https://hyunjimoon.github.io/SBC/articles/implementing_backends.html">Implementing backends vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="citing-sbc-and-related-software">Citing SBC and related software<a class="anchor" aria-label="anchor" href="#citing-sbc-and-related-software"></a>
</h2>
<p>Developing and maintaining open source software is an important yet often underappreciated contribution to scientific progress. Thus, whenever you are using open source software, please make sure to cite it appropriately so that developers get credit for their work.</p>
<p>When using SBC, please cite the following publication:</p>
<p>Modrák, M., Moon, A. H., Kim, S., Bürkner, P., Huurre, N., Faltejsková, K., … &amp; Vehtari, A. (2023). Simulation-based calibration checking for Bayesian computation: The choice of test quantities shapes sensitivity. Bayesian Analysis, advance publication, DOI: <a href="https://doi.org/10.1214/23-BA1404" class="external-link">10.1214/23-BA1404</a>.</p>
<p>Further, SBC relies on several other R packages and, of course, on R itself. To find out how to cite R and its packages, use <code>citation</code> function. SBC specifically rely on <code>posterior</code> for manipulating posterior draws and <code>future</code> for parallel processing. Also, do not forget to cite the probabilistic inference tool you use as backend (e.g. Stan, JAGS, brms, …)</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Theoretical support
<ul>
<li>
<a href="https://doi.org/10.1214/23-BA1404" class="external-link">Simulation-Based Calibration Checking for Bayesian Computation: The Choice of Test Quantities Shapes Sensitivity</a> Modrák, Moon, Kim, Bürkner, Huurre, Faltejsková, Gelman, Vehtari, 2023</li>
<li>
<a href="http://www.stat.columbia.edu/~gelman/research/unpublished/sbc.pdf" class="external-link">Validating Bayesian Inference Algorithms with Simulation-Based Calibration</a> Talts, Betancourt, Simpson, Vehtari, Gelman, 2018</li>
<li>
<a href="https://arxiv.org/abs/2103.10522" class="external-link">Graphical Test for Discrete Uniformity and its Applications in Goodness of Fit Evaluation and Multiple Sample Comparison</a> Säilynoja, Bürkner, Vehtari, 2021</li>
<li>
<a href="https://arxiv.org/abs/2011.01808" class="external-link">Bayesian Workflow</a>, Gelman et al., 2020</li>
<li>
<a href="https://psycnet.apa.org/record/2020-43606-001" class="external-link">Toward a principled Bayesian workflow in cognitive science</a> Schad, Betancourt, Vasishth, 2021</li>
<li>
<a href="https://arxiv.org/pdf/2103.08744.pdf" class="external-link">Bayes factor workflow</a> Schad, Nicenboim, Bürkner, Betancourt, Vasishth, 2021</li>
</ul>
</li>
<li>Application support
<ul>
<li><a href="https://link.springer.com/content/pdf/10.3758/s13428-019-01318-x.pdf" class="external-link">Cognitive science, response time fitting</a></li>
<li><a href="https://www.biorxiv.org/content/10.1101/2020.10.27.356758v1.full.pdf" class="external-link">Bioinformatics, effect of mutation prediction</a></li>
<li><a href="https://gmd.copernicus.org/articles/11/4383/2018/gmd-11-4383-2018.pdf" class="external-link">Earth science, earthquake prediction</a></li>
<li><a href="http://proceedings.mlr.press/v89/papamakarios19a/papamakarios19a.pdf" class="external-link">Sequential Neural Likelihood</a></li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="faq">FAQ<a class="anchor" aria-label="anchor" href="#faq"></a>
</h2>
<blockquote>
<p>How does calibration relate to prediction accuracy?</p>
</blockquote>
<p>Comparing the ground truth and the simulated result is a backbone of calibration and comparison target greatly affects the calibrated (i.e. trained) result, similar to reward in reinforcement learning. In this sense, if the U(a(y), theta) term is designed for prediction, the model will be calibrated to have best predictive result as possible.</p>
</div>
<div class="section level2">
<h2 id="acknowledgements">Acknowledgements<a class="anchor" aria-label="anchor" href="#acknowledgements"></a>
</h2>
<p>Development of this package was supported by <a href="https://www.elixir-czech.cz/" class="external-link">ELIXIR CZ</a> research infrastructure project (Ministry of Youth, Education and Sports of the Czech Republic, Grant No: LM2018131) including access to computing and storage facilities.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/hyunjimoon/SBC/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/hyunjimoon/SBC/issues" class="external-link">Report a bug</a></li>
<li><a href="http://discourse.mc-stan.org/" class="external-link">Ask a question</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing SBC</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Shinyoung Kim <br><small class="roles"> Author </small>  </li>
<li>Angie.H Moon <br><small class="roles"> Author, maintainer </small>  </li>
<li>Martin Modrák <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-8886-7797" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Teemu Säilynoja <br><small class="roles"> Author </small>  </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Shinyoung Kim, Angie.H Moon, Martin Modrák, Teemu Säilynoja.</p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>This site uses <a href="https://plausible.io" class="external-link">Plausible.io</a> for privacy-friendly web analytics (no cookies, no tracking).</p>
<p>Our stats are public at: <a href="https://plausible.io/hyunjimoon.github.io" class="external-link uri">https://plausible.io/hyunjimoon.github.io</a></p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
